(function(g){var v="Zumo";var a="0.1";var l={LEVELS:["error","warn","info","debug"],level:2,prefix:v.toUpperCase()+" - ",debug:function(z){if(typeof z=="string"){z=this.prefix+z}this._log(z,3)},info:function(z){this._log(this.prefix+z,2)},warn:function(z){this._log(this.prefix+z,1)},error:function(z){this._log(this.prefix+z,0)},_log:function(A,B){if(!g.console){return}if(B==null){B=this.level}if(this.level>=B){var z=g.console[this.LEVELS[B]];if(typeof z=="function"){z.call(g.console,A)}}}};var d={_registry:[],observe:function(){var C=this._buildRequest.apply(this,arguments);if(!C.success){return}var A=C.o;var F=C.fName;var H=C.hook;var I=C.thisArg;var J=C.priority;var B=A[F];if(B!=undefined&&(typeof B!="function")){t.log.warn('The provided function name "'+F+'" does not reference a function but a '+(typeof A[F])+" - this member should be changed at runtime to a function in order to avoid unexpected results")}var E=false;var G;for(var D=0;D<this._registry.length;D++){var z=this._registry[D];if(z.o===A&&z.fName==F){G=z;E=true;break}}if(!E){G=this._createProxy(A,F)}this._addHook(G,H,I,J)},ignore:function(){var B=this._buildRequest.apply(this,arguments);if(!B.success){return}var F=B.o;var D=B.fName;var C=B.hook;var A=-1;for(var z=0;z<this._registry.length;z++){var E=this._registry[z];if(E.o===F&&E.fName==D&&E.hook===C){A=z;break}}if(A>-1){this._registry.splice(A,1)}else{t.log.info("There is no matching function to remove on "+D)}},_buildRequest:function(){if(typeof arguments[0]!="object"&&typeof arguments[0]!="string"){t.log.warn("The first parameter to observe/ignore should be either an object (that holds the function to be observed/ignored) or a string (the function name to be obeserved/ignored, taking window as the default object), no hook will be processed");return}var C=(typeof arguments[0]=="string");var B={o:C?g:arguments[0],fName:C?arguments[0]:arguments[1],hook:C?arguments[1]:arguments[2],thisArg:null,priority:0,success:true};if(arguments.length>(C?2:3)){var A=C?(arguments[2]):(arguments[3]);var z=C?(arguments[3]):(arguments[4]);if(A&&typeof A=="object"){B.thisArg=A;if(z&&typeof z=="number"){B.priority=z}}else{if(typeof A=="number"){B.priority=A}}}if(typeof B.o!="object"){t.log.warn("No object to observe, no hook will be processed");B.success=false}else{if(typeof B.fName!="string"){t.log.warn("There was no function name string provided to observe, no hook will be processed");B.success=false}else{if(typeof B.hook!="function"){t.log.warn("There was no hook function provided to observe, no hook will be processed");B.success=false}}}return B},_createProxy:function(C,B){var A={o:C,fName:B,hooks:[]};var z=C[B];this._addHook(A,z,0);A.original=z;this._registry.push(A);return A},_buildProxy:function(z){z.o[z.fName]=function(){for(var A=z.hooks.length-1;A>=0;A--){var B=z.hooks[A];B.f.apply(B.thisArg||this,arguments)}}},_addHook:function(D,C,F,G){if(!C){return}if(D.original===C){t.log.warn("You cannot observe a function to itself: "+C);return}var z=0;var H=false;for(var A=0;A<D.hooks.length;A++){var B=D.hooks[A];if(B.f===C){H=true;break}if(B.priority<G){z=A+1}}if(H){t.log.info("Hook already exists, will not be added: "+C)}else{var E={f:C,thisArg:F,priority:G};D.hooks.splice(z,0,E)}this._buildProxy(D)}};var s={create:function(B,A,z){return function(){B.apply(A,z)}}};var y={trim:function(z){z=z||"";return z.replace(/^\s+|\s+$/g,"")},ltrim:function(z){z=z||"";return z.replace(/^\s+/,"")},rtrim:function(z){z=z||"";return z.replace(/\s+$/,"")}};var i={extend:function(A,z){A.prototype.__proto__=z.prototype},merge:function(D,A){var B,z=1,C,E;if(!D||!A){return}if(A.length){z=A.length}for(B=0;B<z;B++){E=(A.length)?A[B]:A;for(C in E){D[C]=E[C]}}},find:function(C,z){var B=C.split(".");var D=z||g;for(var A=0;A<B.length;A++){D=D[B[A]];if(!D){break}}return D},isEmpty:function(A){var z;if(A){if(typeof A=="object"){for(z in A){return false}}else{if(typeof A=="string"){return y.trim(A)==""}else{return false}}}else{return true}}};var q={getChildren:function(C,z){var B=[];if(C&&C.childNodes.length){for(var A=0;A<C.childNodes.length;A++){var D=C.childNodes[A];if(D.nodeType==1&&(!z||D.nodeName==z)){B.push(D)}}}return B}};var p={select:function(z,A){A=document;return A.getElementById(z.substr(1))}};var f=function(){this.method="GET"};f.prototype={load:function(A,B,C){this.callback=B;this.callbackObject=C;var D=this.onState;var z=this;if(g.XMLHttpRequest){this.xmlHttp=new XMLHttpRequest();this.xmlHttp.onreadystatechange=function(){z.onState.call(z)};this.xmlHttp.open(this.method,A,true);this.xmlHttp.send(null)}else{if(g.ActiveXObject){l.info("Loader using ActiveX");this.xmlHttp=new ActiveXObject("Microsoft.XMLHTTP");if(this.xmlHttp){this.xmlHttp.onreadystatechange=function(){z.onState.call(z)};this.xmlHttp.open(this.method,A,true);this.xmlHttp.send()}}}if(!this.xmlHttp){l.error("Loader could not create an XML HTTP object")}},onState:function(){if(this.xmlHttp.readyState==4){if(this.xmlHttp.status==200||this.xmlHttp.status==0){this.onLoaded(this.xmlHttp)}else{l.warn("The server returned an error when trying to load: "+this.xmlHttp.responseXML)}}},onLoaded:function(z){l.debug("The server returned content from Loader");if(typeof this.callback=="function"){this.callback.call(this.callbackObject,z)}}};var k={apply:function(E,D,C){if(!E||!D){return}for(var A=0;A<D.length;A++){var B=D[A];var F=E;if(B.target){F=C.selector(B.target,E)}if(F){var z=B.name||C.defaultPropName;F[z]=B.value}}}};var u={apply:function(B,D,A){for(var z=0;z<D.length;z++){var C=D[z];B[C.name]=C.value}}};var j=function(z,A,B){this.id=z.id;this.context=z;this.request=A;this.session=B};var n=function(z,A,B){this.id=z.id;this.context=z;this.request=A;this.session=B;this._callers=[]};n.prototype={addCaller:function(z){if(!this.existsCaller(z)){this._callers.push(z)}},removeCaller:function(A){var z=this._callers.indexOf(A);if(z!=-1){this._callers.splice(z,1)}},existsCaller:function(B){var A=false,z;for(z=0;z<this._callers;z++){if(this._callers[z]==B){A=true;break}}return A},getCallers:function(){return this._callers}};var m={createPage:function(z,A,C){var B=new j(z,A,C),D=this._buildStateManager(z,C);B.master=this._buildMaster(z,A,C,D);D.master=B.master;return B},createBlock:function(z,A,B){var D=new n(z,A,B),C=this._buildStateManager(z,B);D.master=this._buildMaster(z,A,B,C);C.master=D.master;return D},_buildMaster:function(A,D,E,F){var z,C;var B=y.trim(A.type).toLowerCase();if(B!=""){z=E.viewMasters["_"+B]}else{z=E.defaultViewMasterClass}if(z){if(typeof z=="function"){C=new z(A,D,E,F)}else{l.error("The type "+B+" in "+A.id+" cannot create a new page")}}else{l.error("The type "+B+" cannot be resolved in page: "+A.id)}return C},_buildStateManager:function(B,C){var z,D;var A=y.trim(B.manager).toLowerCase();if(A!=""){z=C.stateManagers["_"+A]}else{z=C.defaultStateManagerClass}if(z){if(typeof z=="function"){D=new z(null,C)}else{l.error("The manager "+A+" in "+B.id+" cannot create a valid state manager")}}else{l.error("The manager "+A+" cannot be resolved in: "+B.id)}return D}};var x={init:function(){var C=function(F,G,H,I){this.context=F;this.request=G;this.session=H;this.stateManager=I;this.isDisplayed=false;this.isCleared=false;if(this.context.mediator){var E=i.find(this.context.mediator);if(typeof E=="function"){this.fMediator=E}}};C.prototype={display:function(){l.info("Displaying "+this.context.id+" with target "+this.context.target);this.onDisplay(this);var E=y.trim(this.context.container);if(E!=""){this.container=this.session.selector(this.context.container,this.session.root);if(this.container==null){l.error("Invalid container for page "+this.context.id+": "+this.context.container)}}},destroy:function(){l.info("Destroying "+this.context.id);if(this.mediator&&typeof this.mediator.destroy=="function"){this.mediator.destroy()}if(this.stateManager){this.stateManager.destroy()}},clear:function(){l.info("Clearing "+this.context.id);this.onClear(this);if(this.stateManager){this.stateManager.setState(w.STATE_OUT)}},init:function(){l.debug("Initializing "+this.context.id);if(this.target){k.apply(this.target,this.context.propContexts,this.session);i.merge(this.target,this.request.params);if(this.fMediator){this.mediator=new this.fMediator(this.target);k.apply(this.mediator,this.context.propContexts,this.session);i.merge(this.mediator,this.request.params);if(typeof this.mediator.init=="function"){this.mediator.init()}}if(this.stateManager){this.stateManager.target=this.target;d.observe(this.stateManager,"onStateChange",this.onStateChange,this);this.stateManager.setState(w.STATE_IN)}}this.onInit(this)},onStateChange:function(F,E){if(E==w.STATE_IN){this.onIn(this)}else{if(E==w.STATE_ON){this.onOn(this)}else{if(E==w.STATE_OUT){this.onOut(this)}else{if(E==w.STATE_OFF){this.onOff(this);this.destroy()}}}}},onDisplay:function(E){},onClear:function(E){},onInit:function(E){},onIn:function(E){},onOn:function(E){},onOut:function(E){},onOff:function(E){}};var B=function(E,F,G,H){C.call(this,E,F,G,H);this.cloneDom=false};B.prototype={display:function(){C.prototype.display.apply(this,arguments);l.debug("DomMaster display: "+this.context.id);this.target=this.session.selector(this.context.target);if(this.target==null){l.error("Invalid target for page "+this.context.id+": "+this.context.target);return}if(this.cloneDom){this.target=this.target.cloneNode(true);this.container.appendChild(this.target)}this.originalDisplay=this._getStyle(this.target,"display");this.originalVisibility=this._getStyle(this.target,"visibility");if(this.originalDisplay=="none"){this.target.style.display="inherit"}if(this.originalVisibility=="hidden"){this.target.style.visibility="visible"}this.init()},destroy:function(){C.prototype.destroy.apply(this,arguments);l.debug("DomMaster destroy: "+this.context.id);this.target.style.display=this.originalDisplay;this.target.style.visibility=this.originalVisibility;if(this.cloneDom){this.container.removeChild(this.target)}},init:function(){C.prototype.init.apply(this,arguments)},clear:function(){C.prototype.clear.apply(this,arguments)},onStateChange:function(F,E){C.prototype.onStateChange.apply(this,arguments)},_getStyle:function(H,F){var G,E;if(H.currentStyle){G=H.currentStyle[F]}else{if(g.getComputedStyle){E=g.getComputedStyle(H,null);if(E){G=E.getPropertyValue(F)}}}return G},onDisplay:function(E){},onClear:function(E){},onInit:function(E){},onIn:function(E){},onOn:function(E){},onOut:function(E){},onOff:function(E){}};var D=function(E,F,G,H){B.call(this,E,F,G,H);this.cloneDom=true};D.prototype={display:function(){B.prototype.display.apply(this,arguments)},destroy:function(){B.prototype.destroy.apply(this,arguments)},init:function(){B.prototype.init.apply(this,arguments)},clear:function(){B.prototype.clear.apply(this,arguments)},onStateChange:function(F,E){B.prototype.onStateChange.apply(this,arguments)},_getStyle:function(F,E){return B.prototype._getStyle.apply(this,arguments)},onDisplay:function(E){},onClear:function(E){},onInit:function(E){},onIn:function(E){},onOn:function(E){},onOut:function(E){},onOff:function(E){}};var A=function(E,F,G,H){C.call(this,E,F,G,H);this.useXml=false;this.loader=null};A.prototype={display:function(){C.prototype.display.apply(this,arguments);l.debug("LoaderMaster display");this.loader=new f();this.loader.load(this.context.target,this.onLoaded,this)},destroy:function(){C.prototype.destroy.apply(this,arguments);l.debug("LoaderMaster destroy");this.container.innerHTML=""},onLoaded:function(E){l.debug("LoaderMaster received content");this.target=E.responseText;this.container.innerHTML=this.target;this.init()},init:function(){C.prototype.init.apply(this,arguments)},clear:function(){B.prototype.clear.apply(this,arguments)},onStateChange:function(F,E){B.prototype.onStateChange.apply(this,arguments)},onDisplay:function(E){},onClear:function(E){},onInit:function(E){},onIn:function(E){},onOn:function(E){},onOut:function(E){},onOff:function(E){}};var z=function(E,F,G,H){C.call(this,E,F,G,H);this.fConstructor=null;this.builder=null;this.domContent=null};z.prototype={display:function(){C.prototype.display.apply(this,arguments);l.debug("BuilderMaster display");this.fConstructor=i.find(this.context.target);if(typeof this.fConstructor!="function"){l.error("Invalid target for page "+this.context.id+": "+this.context.target);return}this.builder=new this.fConstructor();this.target=this.builder.build();this.container.appendChild(this.target);this.init();if(typeof this.builder.init=="function"){this.builder.init()}},destroy:function(){C.prototype.destroy.apply(this,arguments);l.debug("BuilderMaster destroy");if(typeof this.builder.destroy=="function"){this.builder.destroy()}if(this.target){this.container.removeChild(this.target)}},init:function(){C.prototype.init.apply(this,arguments);k.apply(this.builder,this.context.propContexts,this.session);i.merge(this.builder,this.request.params)}};this.AbstractMaster=C;this.DomMaster=B;this.DomCloneMaster=D;this.LoaderMaster=A;this.BuilderMaster=z}};var w={STATE_IN:"IN",STATE_ON:"ON",STATE_OUT:"OUT",STATE_OFF:"OFF",init:function(){var z=function(B,A){this.target=B;this.session=A;this._state=null};z.prototype={destroy:function(){},getState:function(){return this._state},setState:function(A){A=A.toUpperCase();if(A!=w.STATE_IN&&A!=w.STATE_ON&&A!=w.STATE_OUT&&A!=w.STATE_OFF){l.warn("Unknown state, returning without changing state for target "+this.target);return}if(A!=this._state){this._state=A;this._changeState()}},_changeState:function(){this.onStateChange(this.target,this._state);if(this._state==w.STATE_IN){this._doIn()}else{if(this._state==w.STATE_ON){this._doOn()}else{if(this._state==w.STATE_OUT){if(this.target!=null){this._doOut()}else{l.info("target is null when trying to set state to OUT, setting state to OFF instead of calling doOut to avoid errors.");this._state=w.STATE_OFF}}else{if(this._state==w.STATE_OFF){this._doOff()}}}}},_doIn:function(){this.setState(w.STATE_ON)},_doOn:function(){},_doOut:function(){this.setState(w.STATE_OFF)},_doOff:function(){},onStateChange:function(B,A){}};this.BaseIo3Manager=z}};var o=function(z,A,B){this.id=z.id;this.context=z;this.request=A;this.session=B};var c={createCommand:function(z,A,B){var C=new o(z,A,B);C.master=this._buildMaster(z,A,B);return C},_buildMaster:function(A,D,E){var z,C;var B=y.trim(A.type).toLowerCase();if(B!=""){z=E.commandMasters["_"+B]}else{z=E.defaultCommandMasterClass}if(z){if(typeof z=="function"){C=new z(A,D,E)}else{l.error("The type "+B+" in "+A.id+" cannot create a new command")}}else{l.error("The type "+B+" cannot be resolved in command: "+A.id)}return C}};var r={init:function(){var A=function(B,C,D){this.context=B;this.request=C;this.session=D;this.isExecuted=false};A.prototype={execute:function(){l.debug("Initializing "+this.context.id)}};var z=function(B,C,D){A.call(this,B,C,D)};z.prototype={execute:function(){A.prototype.execute.apply(this,arguments);var D=i.find(this.context.target),B=[],C={};i.merge(C,[this.context.props,this.request.params]);if(C._args&&C._args.length){B=C._args.slice(0)}if(!i.isEmpty(C)){B.push(C)}if(typeof D=="function"){D.apply(null,B)}else{l.warn("There is no function to execute for command '"+this.context.id+"' and target '"+this.context.target+"'.")}this.isExecuted=true}};this.AbstractMaster=A;this.FunctionMaster=z}};var b={parse:function(A,B){var z={};z.views=this._parseViews(A,B);z.commands=this._parseCommands(A,B);return z},_parseViews:function(D,F){var B=D.getElementsByTagName("views");if(B.length>1){l.warn("There can only be zero or one views nodes on the XML configuration, there were "+B.length+" views nodes found");return}else{if(B.length==0){l.info("No views to parse");return}}var I={pages:[],blocks:[]};var G="page";var H=B[0].getElementsByTagName(G);for(var A=0;A<H.length;A++){var E=this._parsePageBlock(H[A],F);if(E){E.node=G;this._mergeAttributes(E,H[A],["parent"]);E.parentId=E.parent;E.parent=null;E.children=[];I.pages.push(E)}}G="block";var z=B[0].getElementsByTagName(G);for(A=0;A<z.length;A++){var C=this._parsePageBlock(z[A],F);if(C){C.node=G;I.blocks.push(C)}}return I},_parsePageBlock:function(z,B){var A={};this._mergeAttributes(A,z,["id","type","mediator","target","container","manager","title"]);var D=z.attributes.getNamedItem("depends");if(D){var C=D.nodeValue.replace(/\s/g,"").split(",");if(!(C.length==1&&C[0]=="")){A.depends=C}}A.propContexts=this._parsePropContexts(z,B);A.props=this._getPropsFromPropContexts(A.propContexts);A.handlers=this._parseHandlers(z,B);return A},_parseCommands:function(A,F){var D=A.getElementsByTagName("commands");var z=[];if(D.length>1){l.warn("There can only be zero or one commands nodes on the XML configuration, there were "+D.length+" commands nodes found")}else{if(D.length==0){l.info("No commands to parse")}else{var E=D[0].getElementsByTagName("command");for(var B=0;B<E.length;B++){var C={};this._mergeAttributes(C,E[B],["id","type","target"]);C.propContexts=this._parsePropContexts(E[B],F);C.props=this._getPropsFromPropContexts(C.propContexts);C.handlers=this._parseHandlers(E[B],F);z.push(C)}}}return z},_parsePropContexts:function(z,E){var B=q.getChildren(z,"prop");var D=[];for(var A=0;A<B.length;A++){var C=this._parsePropContext(B[A],E);if(C){D.push(C)}}return D},_parsePropContext:function(z,B){var A={};this._mergeAttributes(A,z,["name","target"]);A.value=this._parsePropValue(z,B);return A},_parsePropValue:function(A,F){var E={};this._mergeAttributes(E,A,["name","value"]);var z=q.getChildren(A).length>0;var D=q.getChildren(A,"item");var C=q.getChildren(A,"prop");if(z){if(E.value){l.warn("Both value attribute and children nodes found on prop: '"+E.name+"'. Only value attribute will be used.")}else{var B;if(C.length>0){if(D.length>0){l.warn("Both prop and item nodes found on prop: '"+E.name+"'. Only prop nodes will be used.")}E.value={};for(B=0;B<C.length;B++){var G=C[B];E.value[G.attributes.getNamedItem("name").nodeValue]=this._parsePropValue(G)}}else{if(D.length>0){E.value=[];for(B=0;B<D.length;B++){E.value.push(this._parsePropValue(D[B]))}}}}}else{if(E.value){if(A.firstChild&&y.trim(A.firstChild.nodeValue)!=""){l.warn("Both value attribute and text content found on prop: '"+E.name+"'. Only value attribute will be used.")}}else{E.value=A.firstChild.nodeValue}}return E.value},_getPropsFromPropContexts:function(B){var A={};for(var z=0;z<B.length;z++){A[B[z].name]=B[z].value}return A},_mergeAttributes:function(E,B,D){for(var A=0;A<D.length;A++){var z=D[A];if(z&&y.trim(z)!=""){var C=B.attributes.getNamedItem(z);if(C){E[z]=C.nodeValue}}}},_parseHandlers:function(B,E){var z=B.getElementsByTagName("handler");var A=[];for(var D=0;D<z.length;D++){var C=this._parseHandler(z[D],E);if(C){A.push(C)}}return A},_parseHandler:function(z,B){var A={};l.debug(z);this._mergeAttributes(A,z,["type","target","priority","class","at","action","priority"]);A.params=this._parseParams(z,B);return A},_parseParams:function(A,D){var C=A.getElementsByTagName("param");var E=[];for(var B=0;B<C.length;B++){var z=this._parseParam(C[B],D);if(z){E.push(z)}}return E},_parseParam:function(A,B){var z={};this._mergeAttributes(z,A,["name","value"]);l.debug(A);if(!z.value){z.value=A.firstChild.nodeValue}return z}};var e=function(z){this.app=z;this._activeHandlers=[];this._bindings=[];this.updateBindings=false};e.prototype={registerHandlers:function(){this.unregisterHandlers();var E=this.app.getPageContexts();for(var B=0;B<E.length;B++){var A=E[B];this._registerHandlersFromContext(A,"page")}var D=this.app.getBlockContexts();for(B=0;B<D.length;B++){var z=D[B];this._registerHandlersFromContext(z,"block")}var F=this.app.getCommandContexts();for(B=0;B<F.length;B++){var C=F[B];this._registerHandlersFromContext(C,"command")}this.updateBindings=this._updateBindings();l.debug("Will update bindings? "+this.updateBindings);if(this.updateBindings){d.observe(this.app,"onPageInit",this.onViewInit,this);d.observe(this.app,"onBlockInit",this.onViewInit,this)}},unregisterHandlers:function(){while(this._activeHandlers.length>0){var z=this._activeHandlers.pop();this._removePageBlockHandlerAction(z)}d.ignore(this.app,"onPageInit",this.onViewInit);d.ignore(this.app,"onBlockInit",this.onViewInit)},_registerHandlersFromContext:function(B,z){for(var A=0;A<B.handlers.length;A++){var C={handlerContext:B.handlers[A],context:B,contextType:z,f:this._createHandlerAction(B.handlers[A],B,z)};this._activeHandlers.push(C)}},_createHandlerAction:function(B,A,z){if(z=="page"){this._createPageHandlerAction(B,A)}else{if(z=="block"){this._createBlockHandlerAction(B,A)}else{if(z=="command"){this._createCommandHandlerAction(B,A)}else{l.warn("Could not create handler action - the context type is neither a page or a block")}}}},_createPageHandlerAction:function(A,z){var D=this.app;var C;var B=function(){var F=arguments[1];var E=D.getCurrentPage();if(!A.at||A.at==""||A.at==E.id){if(E&&z.id==E.id){l.debug("Handler "+A.type+"trigger when already at "+E.id);u.apply(E.master.target,A.params,this.session)}else{var G=s.create(D.go,D,[z.id,F]);setTimeout(G,10)}}};if(A.action=="go"||A.action=="go"||A.action=="call"||A.action==""||A.action==null){C=B}else{l.warn("Could not resolve handler action: "+A.action)}this._registerBinding(A.type,C,A.target);return C},_createBlockHandlerAction:function(B,z){var E=this.app;var D;var A=function(){var G=arguments[1];if(!B.at||B.at==""||B.at==E.getCurrentPage().id){var F=E.getDisplayedBlock(z.id);if(F){u.apply(F.master.target,B.params,this.session)}else{E.displayBlock(z.id,G)}}};var C=function(){if(!B.at||B.at==""||B.at==E.getCurrentPage().id){E.clearBlock(z.id)}};if(B.action=="clearBlock"){D=C}else{if(B.action=="displayBlock"||B.action=="call"||B.action==""||B.action==null){D=A}else{l.warn("Could not resolve handler action: "+B.action)}}this._registerBinding(B.type,D,B.target);return D},_createCommandHandlerAction:function(z,A){var D=this.app;var B;var C=function(){var E=D.getCurrentPage();if(!z.at||z.at==""||z.at==E.id){var F=arguments[1];D.execute(A.id,F)}};if(z.action=="execute"||z.action==""||z.action==null){B=C}else{l.warn("Could not resolve handler action: "+z.action)}this._registerBinding(z.type,B,z.target);return B},_removePageBlockHandlerAction:function(z){if(z.contextType=="page"){this._removePageHandlerAction(z)}else{if(z.contextType=="block"){this._removeBlockHandlerAction(z)}else{l.warn("Could not remove handler action - the context type is neither a page or a block")}}},_removePageHandlerAction:function(z){},_removeBlockHandlerAction:function(z){},_registerBinding:function(A,z,B){this._bindings.push({type:A,f:z,target:B})},_bindHandler:function(A,z,B){l.info("There is no handler binder implemented");return true},_unbindHandler:function(A,z,B){l.info("There is no handler unbinder implemented");return true},_updateBindings:function(B){var C,A,z=false;for(A=0;A<this._bindings.length;A++){C=this._bindings[A];if(!B||C.target){this._unbindHandler(C.type,C.f,C.target);if(!this._bindHandler(C.type,C.f,C.target)){z=true}}}return z},onViewInit:function(){this._updateBindings(true)}};var t={ObjectUtils:i,ViewMasters:x,StateManagers:w,_VIEW_MASTERS:{_dom:"DomMaster",_domclone:"DomCloneMaster",_loader:"LoaderMaster",_builder:"BuilderMaster"},_DEFAULT_VIEW_TYPE:"_dom",_STATE_MANAGERS:{_base:"BaseIo3Manager"},_DEFAULT_STATE_MANAGER:"_base",_COMMAND_MASTERS:{_function:"FunctionMaster"},_DEFAULT_COMMAND_TYPE:"_function",_DEFAULT_PROP_NAME:"innerHTML",_PARAM_NAME_CALLER:"_caller",log:l,root:null,session:{viewMasters:{},defaultViewMasterClass:null,stateManagers:{},defaultStateManagerClass:null,commandMasters:{},defaultCommandMasterClass:null,selector:p.select,confParsers:[]},_conf:null,_params:null,_currentPage:null,_displayedPage:null,_displayedBlocks:[],_handlerManager:null,startup:function(){this["goto"]=this.go;this._initViewMasters();this._initStateManagers();this._initCommandMasters()},init:function(z,A,B){z=z||document;A=A||z;this._params=B||{};this.root=z;l.info("Initializing Zumo object with root "+z);this._displayedBlocks=[];this.session.id=this._params.id||this._createSessionId();this.session.root=z;this.session.defaultPropName=this._DEFAULT_PROP_NAME;this.session.confParsers.push(this._parseConf);this._handlerManager=new e(this);this._initConf(A);l.info("New Zumo session created with id: "+this.session.id)},destroy:function(){l.debug("Destroying Zumo object");this.session={};this.root=this._conf=this._params=this._currentPage=this._displayedPage=null},isInit:function(){return this.root!=null&&this._conf!=null},go:function(D,C){l.info("Going to page "+D);if(!this.isInit()){l.warn("Cannot go "+D+" - Zumo is not yet initalized");return}C=C||{};if(this._currentPage!=null){l.debug("currentPage id = "+this._currentPage.id);if(D==this._currentPage.context.id){l.info("No page to go - we are already in "+D);return}}else{l.debug("currentPage is null")}var z=this.getPageContext(D);if(!z||typeof z!=="object"){l.error("No page context found with id: "+D);return}var A={id:D,params:C,referrer:this._currentPage};var B=m.createPage(z,A,this.session);this.onPageRequest(z,A);if(B.master==null){return}d.observe(B.master,"onDisplay",this.onPageDisplay,this);d.observe(B.master,"onClear",this.onPageClear,this);d.observe(B.master,"onInit",this.onPageInit,this);d.observe(B.master,"onIn",this.onPageIn,this);d.observe(B.master,"onOn",this.onPageOn,this);d.observe(B.master,"onOut",this.onPageOut,this);d.observe(B.master,"onOff",this.onPageOff,this);if(this._currentPage!=null){this._currentPage.master.clear()}this._currentPage=B;B.master.display();this._displayedPage=B;this._displayDepends(B)},getPageContext:function(C){if(!this.isInit()){l.warn("Cannot get page context ("+C+")- Zumo is not yet initalized");return}if(this._conf.views==null){l.info("Cannot get page context since there are no views configured");return}var z;for(var A=0;A<this._conf.views.pages.length;A++){var B=this._conf.views.pages[A];if(B.id==C){z=B;break}}return z},getPageContexts:function(){return this._conf.views.pages},getPageContextsAt:function(C){var z=[],B;for(B=0;B<this._conf.views.pages.length;B++){var A=this._conf.views.pages[B];if(A.level==C){z.push(A)}}return z},getDisplayedPage:function(){return this._displayedPage},getCurrentPage:function(){return this._currentPage},getPageLevel:function(B){var A=0,z=this.getPageContext(B);if(z.parentId!=null){A=this.getPageLevel(z.parentId)+1}return A},displayBlock:function(D,C){l.info("Displaying block "+D);if(!this.isInit()){l.warn("Cannot display "+D+" - Zumo is not yet initalized");return}C=C||{};var B=this.getDisplayedBlock(D);if(B){if(C[this._PARAM_NAME_CALLER]){B.addCaller(C[this._PARAM_NAME_CALLER])}else{B.addCaller(B.id)}l.info("No block to display - the block is already displayed: "+D)}else{var z=this.getBlockContext(D);if(!z||typeof z!=="object"){l.error("No block context found with id: "+D);return}var A={id:D,params:C};B=m.createBlock(z,A,this.session);this.onBlockRequest(z,A);if(B.master==null){return}d.observe(B.master,"onDisplay",this.onBlockDisplay,this);d.observe(B.master,"onClear",this.onBlockClear,this);d.observe(B.master,"onInit",this.onBlockInit,this);d.observe(B.master,"onIn",this.onBlockIn,this);d.observe(B.master,"onOn",this.onBlockOn,this);d.observe(B.master,"onOut",this.onBlockOut,this);d.observe(B.master,"onOff",this.onBlockOff,this);if(C[this._PARAM_NAME_CALLER]){B.request.caller=C[this._PARAM_NAME_CALLER]}else{B.request.caller=B.id}B.addCaller(B.request.caller);B.master.display();this._addDisplayedBlock(B);this._displayDepends(B)}},clearBlock:function(A){l.info("Clearing block "+A);var z=this.getDisplayedBlock(A);if(!z){l.info("There is no block to clear with id "+A);return}if(z.master.isCleared){l.info("The block is already being cleared: "+A);return}z.master.clear();this._removeDisplayedBlock(A);this._clearDepends(z)},getBlockContext:function(C){if(!this.isInit()){l.warn("Cannot get block context ("+C+")- Zumo is not yet initalized");return}if(this._conf.views==null){l.info("Cannot get block context since there are no views configured");return}var z;for(var B=0;B<this._conf.views.blocks.length;B++){var A=this._conf.views.blocks[B];if(A.id==C){z=A;break}}return z},getBlockContexts:function(){return this._conf.views.blocks},getDisplayedBlock:function(B){var A;for(var z=0;z<this._displayedBlocks.length;z++){if(this._displayedBlocks[z].id==B){A=this._displayedBlocks[z];break}}return A},getDisplayedBlocks:function(z){return this._displayedBlocks},registerViewMaster:function(z,A){if(y.trim(z)==""){l.warn("Cannot register a view master with an empty name");return}if(typeof A!="function"){l.warn("Cannot register view master with name "+z+" - master is not a function");return}if(this.session.viewMasters[z]==null){this.session.viewMasters[z]=A}else{l.warn("Cannot register view master with name "+z+" - there is already registered a masterwith that name")}},unregisterViewMaster:function(z){this.session.viewMasters[z]=null},registerStateManager:function(z,A){if(y.trim(z)==""){l.warn("Cannot register a state manager with an empty name");return}if(typeof A!="function"){l.warn("Cannot register state manager with name "+z+" - manager is not a function");return}if(this.session.stateManagers[z]==null){this.session.stateManagers[z]=A}else{l.warn("Cannot register state manager with name "+z+" - there is already registered a managerwith that name")}},unregisterStateManager:function(z){this.session.stateManagers[z]=null},execute:function(D,C){l.info("Executing command "+D);if(!this.isInit()){l.warn("Cannot execute "+D+" - Zumo is not yet initalized");return}C=C||{};var z=this.getCommandContext(D);if(!z||typeof z!=="object"){l.error("No command context found with id: "+D);return}var A={id:D,params:C};var B=c.createCommand(z,A,this.session);B.master.execute(A)},getCommandContexts:function(){return this._conf.commands},getCommandContext:function(C){if(!this.isInit()){l.warn("Cannot get command context ("+C+")- Zumo is not yet initalized");return}if(this._conf.commands==null||this._conf.commands.length==0){l.info("Cannot get block context since there are no commands configured");return}var A;for(var z=0;z<this._conf.commands.length;z++){var B=this._conf.commands[z];if(B.id==C){A=B;break}}return A},registerCommandMaster:function(z,A){if(y.trim(z)==""){l.warn("Cannot register a command master with an empty name");return}if(typeof A!="function"){l.warn("Cannot register command master with name "+z+" - command is not a function");return}if(this.session.commandMasters[z]==null){this.session.commandMasters[z]=A}else{l.warn("Cannot register command master with name "+z+" - there is already registered a masterwith that name")}},unregisterCommandMaster:function(z){this.session.commandMasters[z]=null},observe:function(B,A,z){d.observe(this,B,A,z)},ignore:function(A,z){d.ignore(this,A,z)},_initConf:function(z){if(typeof z=="string"){l.info("Initializing with remote configuration: "+z);var A=new f();A.load(z,this._onConfLoaded,this)}else{this._processConf(z)}},_initViewMasters:function(){x.init();for(var A in this._VIEW_MASTERS){var z=this._VIEW_MASTERS[A];this.registerViewMaster(A,x[z])}this.session.defaultViewMasterClass=this.session.viewMasters[this._DEFAULT_VIEW_TYPE]},_initStateManagers:function(){w.init();for(var A in this._STATE_MANAGERS){var z=this._STATE_MANAGERS[A];this.registerStateManager(A,w[z])}this.session.defaultStateManagerClass=this.session.stateManagers[this._DEFAULT_STATE_MANAGER]},_initCommandMasters:function(){r.init();for(var A in this._COMMAND_MASTERS){var z=this._COMMAND_MASTERS[A];this.registerCommandMaster(A,r[z])}this.session.defaultCommandMasterClass=this.session.commandMasters[this._DEFAULT_COMMAND_TYPE]},_createSessionId:function(){if(g._nZumo==null){g._nZumo=0}g._nZumo++;return v+g._nZumo},_addDisplayedBlock:function(z){if(!this.getDisplayedBlock(z.id)){this._displayedBlocks.push(z)}},_removeDisplayedBlock:function(A){var z;for(z=0;z<this._displayedBlocks.length;z++){if(this._displayedBlocks[z].id==A){break}}this._displayedBlocks.splice(z,1)},_displayDepends:function(C){l.debug("Displaying depends for "+C.id);if(!C){return}var z=this._getFlattenedDepends(C);for(var B=0;B<z.length;B++){var D={};D[this._PARAM_NAME_CALLER]=C.id;this.displayBlock(z[B],D)}if(C.context.node=="page"){var A=C.request.referrer;if(A!=null){this._clearDepends(A)}}},_clearDepends:function(B){l.debug("Clearing depends for "+B.id);if(!B){return}var z=this._getFlattenedDepends(B);for(var A=0;A<z.length;A++){var C=this.getDisplayedBlock(z[A]);if(!C){continue}C.removeCaller(B.id);if(C.getCallers().length==0){this.clearBlock(C.id)}}},_getFlattenedDepends:function(E,C){var A=C||[];var D=E.depends;if(!D&&E.context){D=E.context.depends}if(!D){return[]}if(!Array.indexOf){Array.prototype.indexOf=function(H){for(var G=0;G<this.length;G++){if(this[G]==H){return G}}return -1}}for(var B=0;B<D.length;B++){var F=D[B];if(A.indexOf(F)!=-1){continue}A.push(F);var z=this.getBlockContext(F);this._getFlattenedDepends(z,A)}return A},_processConf:function(B){var z,C,A;for(z=0;z<this.session.confParsers.length;z++){C=this.session.confParsers[z];if((typeof C=="function")&&(A=C(B))){break}}this._conf=A;this._processParenting();this._handlerManager.registerHandlers();this.onConfLoaded()},_processParenting:function(){var z=this.getPageContexts(),B,A;for(B=0;B<z.length;B++){A=z[B];if(A.parentId){var C=this.getPageContext(A.parentId);if(!C){l.warn("Parent node '"+A.parentId+"' cannot be found for '"+A.id+"'");continue}if(!A.parent){A.parent=C;C.children.push(A);A.level=this.getPageLevel(A.id)}}}},_parseConf:function(z){return b.parse(z,this.session)},onConfLoaded:function(){},onPageRequest:function(z,A){},onPageDisplay:function(z){},onPageClear:function(z){},onPageInit:function(z){},onPageIn:function(z){},onPageOn:function(z){},onPageOut:function(z){},onPageOff:function(z){},onBlockRequest:function(z,A){},onBlockDisplay:function(z){},onBlockClear:function(z){},onBlockInit:function(z){},onBlockIn:function(z){},onBlockOn:function(z){},onBlockOut:function(z){},onBlockOff:function(z){},_onConfLoaded:function(z){l.info("Conf was loaded");this._processConf(z.responseXML)}};var h={addHandlerBinder:function(A,B,z){e.prototype._bindHandler=A;e.prototype._unbindHandler=B},setSelector:function(z){if(z&&typeof z=="function"){t.session.selector=z}else{l.warn("Could not create a selector function from "+z)}},addConfParser:function(z){t.session.confParsers.unshift(z)}};t.startup();g.Zumo=t;g.ZumoExt=h;g.ZumoAgent=d})(this);(function(f){if(!Zumo||!ZumoExt){return}var d=function(j,i,k){k=k||$("body");var h=$(k);if(h.length>0){$(k).on(j,i);return true}else{return false}};var c=function(j,i,k){k=k||f;var h=$(k);if(h.length>0){h.off(j,i);return true}else{return false}};ZumoExt.addHandlerBinder(d,c,true);var b=function(h,i){return $(h,i)[0]};ZumoExt.setSelector(b);var a=function(h,i,j,k){Zumo.ViewMasters.AbstractMaster.call(this,h,i,j,k)};a.prototype={display:function(){Zumo.ViewMasters.AbstractMaster.prototype.display.apply(this,arguments);var h=this;this.$container=$(this.container);this.$container.load(this.context.target,function(){h.init()})},destroy:function(){Zumo.ViewMasters.AbstractMaster.prototype.destroy.apply(this,arguments);this.$container.clear()},init:function(){Zumo.ViewMasters.AbstractMaster.prototype.init.apply(this,arguments)},clear:function(){Zumo.ViewMasters.AbstractMaster.prototype.clear.apply(this,arguments)},onStateChange:function(i,h){Zumo.ViewMasters.AbstractMaster.prototype.onStateChange.apply(this,arguments)},onDisplay:function(h){},onClear:function(h){},onInit:function(h){},onIn:function(h){},onOn:function(h){},onOut:function(h){},onOff:function(h){}};Zumo.registerViewMaster("_$loader",a);var e={init:function(){var h=function(j,i){Zumo.StateManagers.BaseIo3Manager.call(this,j,i)};h.prototype={_doIn:function(){var j=this;var i=$(this.target);i.css("display","none");i.fadeIn("slow",function(){j.setState(Zumo.StateManagers.STATE_ON)})},_doOut:function(){var i=this;$(this.target).fadeOut("slow",function(){i.setState(Zumo.StateManagers.STATE_OFF)})}};Zumo.ObjectUtils.extend(h,Zumo.StateManagers.BaseIo3Manager);Zumo.registerStateManager("_$fade",h)}};e.init();var g=function(k){var i={},j,h;if(typeof k!="object"||typeof k.getElementsByTagName!="function"||(k.firstChild&&k.firstChild.nodeName=="zumo")){return null}j=function(r,n,q){for(var m=0;m<q.length;m++){var l=q[m];var p=$(n).attr("data-"+l);if(p){r[l]=p}}};h=function(p){var s=$(p),l={},m,n,r,q,t,o;j(l,p,["type","mediator","container","manager","title"]);l.target=p;m=s.attr("data-depends");if(m){l.depends=m.replace(/\s/g," ").split(" ")}else{l.depends=[]}l.handlers=[];n=s.attr("data-handlers");if(n){r=n.split(",");for(o=0;o<r.length;o++){q=r[o].replace(/\s/g,"").split(":");if(q.length>1){t={target:q[0],type:q[1]}}else{t={type:q[0]}}l.handlers.push(t)}}return l};i.views={pages:[],blocks:[]};i.commands=[];$("*[data-page]",k).each(function(){var l=h(this);l.id=$(this).attr("data-page");l.node="page";i.views.pages.push(l)});$("*[data-block]",k).each(function(){var l=h(this);l.id=$(this).attr("data-block");l.node="block";i.views.blocks.push(l)});return i};ZumoExt.addConfParser(g)})(this);