(function(i){var u="Zumo",b="0.4";var e={_registry:[],observe:function(){var A=this._buildRequest.apply(this,arguments);if(!A.success){return}var y=A.o,D=A.fName,F=A.hook,H=A.thisContext,G=A.priority,z,C,E,B,x;z=y[D];if(z!=undefined&&(typeof z!="function")){this._warn('The provided function name "'+D+'" does not reference a function but a '+(typeof y[D])+" - this member should be changed at runtime to a function in order to avoid unexpected results")}C=false;for(B=0;B<this._registry.length;B++){x=this._registry[B];if(x.o===y&&x.fName==D){E=x;C=true;break}}if(!C){E=this._createProxy(y,D)}this._addHook(E,F,H,G)},ignore:function(){var A=this._buildRequest.apply(this,arguments);if(!A.success){return}var E=A.o,C=A.fName,B=A.hook,z,y,D,x;for(y=0;y<this._registry.length;y++){D=this._registry[y];if(D.o===E&&D.fName==C){for(x=0;x<D.hooks.length;x++){if(D.hooks[x].f===B){z=true;D.hooks.splice(x,1);break}}}}if(!z){this._warn("There is no matching function to remove on "+C)}},_buildRequest:function(){if(typeof arguments[0]!="object"&&typeof arguments[0]!="string"){this._warn("The first parameter to observe/ignore should be either an object (that holds the function to be observed/ignored) or a string (the function name to be obeserved/ignored, taking window as the default object), no hook will be processed");return}var A=(typeof arguments[0]=="string"),z={o:A?i:arguments[0],fName:A?arguments[0]:arguments[1],hook:A?arguments[1]:arguments[2],thisContext:null,priority:0,success:true},y,x;if(arguments.length>(A?2:3)){y=A?(arguments[2]):(arguments[3]);x=A?(arguments[3]):(arguments[4]);if(y&&typeof y=="object"){z.thisContext=y;if(x&&typeof x=="number"){z.priority=x}}else{if(typeof y=="number"){z.priority=y}}}if(typeof z.o!="object"){this._warn("No object to observe, no hook will be processed");z.success=false}else{if(typeof z.fName!="string"){this._warn("There was no function name string provided to observe, no hook will be processed");z.success=false}else{if(typeof z.hook!="function"){this._warn("There was no hook function provided to observe, no hook will be processed");z.success=false}}}return z},_createProxy:function(A,z){var y=A[z],x={o:A,fName:z,hooks:[]};this._addHook(x,y,0);x.original=y;this._registry.push(x);return x},_buildProxy:function(x){x.o[x.fName]=function(){var z,y;for(y=x.hooks.length-1;y>=0;y--){z=x.hooks[y];z.f.apply(z.thisContext||this,arguments)}}},_addHook:function(B,A,F,D){if(!A){return}if(B.original===A){this._warn("You cannot observe a function to itself: "+A);return}var x=0,E=false,y,z,C;for(y=0;y<B.hooks.length;y++){z=B.hooks[y];if(z.f===A){E=true;break}if(z.priority<D){x=y+1}}if(E){this._warn("Hook already exists, will not be added: "+A)}else{C={f:A,thisContext:F,priority:D};B.hooks.splice(x,0,C)}this._buildProxy(B)},_warn:function(x){if(i.console&&typeof i.console.warn=="function"){i.console.warn(x)}}};var m={LEVELS:["error","warn","info","debug"],level:1,prefix:"",debug:function(x){if(typeof x=="string"){x=this.prefix+x}this._log(x,3)},info:function(x){this._log(this.prefix+x,2)},warn:function(x){this._log(this.prefix+x,1)},error:function(x){this._log(this.prefix+x,0)},_log:function(y,z){var x;if(!i.console){return}if(z==null){z=this.level}if(this.level>=z){x=i.console[this.LEVELS[z]];if(typeof x=="function"){x.call(i.console,y)}}}};var a={delegate:function(z,y){var x=[].slice.call(arguments,2);return function(){return z.apply(y,(arguments.length==0)?x:arguments)}},trim:function(x){x=x||"";return x.replace(/^\s+|\s+$/g,"")},ltrim:function(x){x=x||"";return x.replace(/^\s+/,"")},rtrim:function(x){x=x||"";return x.replace(/\s+$/,"")},mix:function(){var x,z,y={};for(x=0;x<arguments.length;x++){for(z in arguments[x]){if(arguments[x].hasOwnProperty(z)){y[z]=arguments[x][z]}}}return y},merge:function(){var x,z,y=arguments[0];if(y&&typeof y=="object"){for(x=1;x<arguments.length;x++){for(z in arguments[x]){if(arguments[x].hasOwnProperty(z)){y[z]=arguments[x][z]}}}}},mergeDeep:function(z,y){var x,A;if(z&&typeof z=="object"&&y&&typeof y=="object"){for(A in y){if(y[A]!==null&&y.hasOwnProperty(A)){if(typeof y[A]=="object"&&typeof z[A]=="object"){if(y[A].hasOwnProperty("length")&&z[A].hasOwnProperty("length")&&typeof z[A].concat=="function"){z[A]=z[A].concat(y[A])}else{this.mergeDeep(z[A],y[A])}}else{z[A]=y[A]}}}}},find:function(A,x){var z=A.split("."),B=x||i,y;for(y=0;y<z.length;y++){B=B[z[y]];if(!B){break}}return B},isEmpty:function(y){var x;if(y){if(typeof y=="object"){for(x in y){if(y.hasOwnProperty(x)){return false}}return true}else{if(typeof y=="string"){return a.trim(y)==""}else{return false}}}else{return true}},getChildren:function(A,x){var z=[],y,B;if(A&&A.childNodes.length){for(y=0;y<A.childNodes.length;y++){B=A.childNodes[y];if(B.nodeType==1&&(!x||B.nodeName==x)){z.push(B)}}}return z},indexOf:function(x,z){var y;if(x.length==undefined||z==null){return null}for(y=0;y<x.length;y++){if(x[y]===z){return y}}return -1},getNestedProperty:function(A,B){if(!A||typeof A!="object"||typeof B!="string"){return null}var y=A,x=B.split("."),z;for(z=0;z<x.length;z++){y=y[x[z]];if(y==null){y=null;break}}if(y==A){y=null}return y}};var q={select:function(x,y){y=document;return y.getElementById(x.substr(1))}};var g=function(){this.method="GET"};g.prototype={load:function(y,z,A,B){var C=this.onState,x=this;this.callback=z;this.callbackObject=A;this.params=B||[];if(i.XMLHttpRequest){this.xmlHttp=new XMLHttpRequest();this.xmlHttp.onreadystatechange=function(){x.onState.call(x)};this.xmlHttp.open(this.method,y,true);this.xmlHttp.send(null)}else{if(i.ActiveXObject){m.info("Loader using ActiveX");this.xmlHttp=new ActiveXObject("Microsoft.XMLHTTP");if(this.xmlHttp){this.xmlHttp.onreadystatechange=function(){x.onState.call(x)};this.xmlHttp.open(this.method,y,true);this.xmlHttp.send()}}}if(!this.xmlHttp){m.error("Loader could not create an XML HTTP object")}},onState:function(){if(this.xmlHttp.readyState==4){if(this.xmlHttp.status==200||this.xmlHttp.status==0){this.onLoaded(this.xmlHttp)}else{m.warn("The server returned an error when trying to load: "+this.xmlHttp.responseXML)}}},onLoaded:function(x){m.debug("The server returned content from Loader");var y=[];if(typeof this.callback=="function"){y.push(x);y=y.concat(this.params);this.callback.apply(this.callbackObject,y)}}};var h=function(){this.evaluators=[];this.add(function(y,x){if(typeof y!="string"){return null}return a.getNestedProperty(x,y)})};h.prototype={opening:"{",closing:"}",add:function(A,y){var x,z;if(A&&!this.contains(A)){if(typeof y=="number"){for(x=0;x<this.evaluators.length;x++){z=this.evaluators[x];if(z.priority<=y){this.evaluators.splice(x,0,{f:A,priority:y})}}}else{this.evaluators.push({f:A,priority:0})}}},remove:function(y){var x=this.indexOf(y);if(x!=-1){this.evaluators.splice(x,1)}},contains:function(x){return this.indexOf(x)!=-1},indexOf:function(y){var x;for(x=0;x<this.evaluators.length;x++){if(this.evaluators[x].f===y){return x}}return -1},clear:function(){this.evaluators=[]},resolve:function(y,A){var x,z,B;if(!y){return y}else{if(typeof y=="string"){return this.resolveFromString(y,A)}else{if(typeof y=="object"){if(y.length!==undefined){x=y.slice(0);for(z=0;z<x.length;z++){x[z]=this.resolve(x[z],A)}}else{x={};for(B in y){x[B]=this.resolve(y[B],A)}}return x}else{return y}}}},resolveFromString:function(I,D){if(!I){return null}var M=[],L,J,A,z,E,C,x,B,G,H,F,K,y;if(typeof D=="object"){J=I.split(this.opening);K=A=J[0];for(E=1;E<J.length;E++){x=J[E-1];B=J[E];if(x.charAt(x.length-1)=="\\"){A+=this.opening+B;continue}G=B.indexOf(this.closing);if(G==-1){m.error("ERROR: Missing closing tag in expression: '"+B+"'")}H=a.trim(B.substring(0,G));for(C=0;C<this.evaluators.length;C++){F=this.evaluators[C].f;L=F(H,D);if(L){M.push(L);break}}y=B.substring(G+1);A+=L+y}if(M.length==1&&K==""&&y==""){z=L}else{A=A.replace("\\"+this.opening,this.opening);A=A.replace("\\"+this.closing,this.closing);z=A}}else{z=I}return z}};var l={apply:function(G,F,H){var z=H.resolver||new h(),y,D,x,I,B,E,C,A;if(!G||!F){return}for(C=0;C<F.length;C++){y=F[C];D=G;if(y.target){D=H.selector(y.target,G)}if(D){x=y.name||H.defaultPropName;I=y.value;I=z.resolve(y.value,s.props);if(y.decorators&&y.decorators.length){for(A=0;A<y.decorators.length;A++){B=y.decorators[A];E=a.find(B);if(typeof E=="function"){I=E.apply(null,[I])}else{m.warn("There is no function for decorator '"+B+"'.")}}}D[x]=I}}},resolve:function(x,y){var z=y.resolver||new h(),A;for(A in x){x[A]=new h().resolve(x[A],s.props)}}};var t={apply:function(z,B,y){var x,A;if(!z||!B){return}for(x=0;x<B.length;x++){A=B[x];z[A.name]=A.value}}};var k=function(x,y,z){this.id=x.id;this.context=x;this.request=y;this.session=z};var o=function(x,y,z){this.id=x.id;this.context=x;this.request=y;this.session=z;this._callers=[]};o.prototype={addCaller:function(x){if(!this.existsCaller(x)){this._callers.push(x)}},removeCaller:function(y){var x=this._callers.indexOf(y);if(x!=-1){this._callers.splice(x,1)}},existsCaller:function(z){var y=false,x;for(x=0;x<this._callers;x++){if(this._callers[x]==z){y=true;break}}return y},getCallers:function(){return this._callers}};var n={createPage:function(x,y,A){var z=new k(x,y,A),B=this._buildStateManager(x,A);z.master=this._buildMaster(x,y,A,B);B.master=z.master;return z},createBlock:function(x,y,z){var B=new o(x,y,z),A=this._buildStateManager(x,z);B.master=this._buildMaster(x,y,z,A);A.master=B.master;return B},_buildMaster:function(y,B,C,D){var x,A,z=a.trim(y.type).toLowerCase();if(z!=""){x=C.viewMasters[z]}else{x=C.defaultViewMasterClass}if(x){if(typeof x=="function"){A=new x(y,B,C,D)}else{m.error("The type '"+z+"' in "+y.id+" cannot create a new page")}}else{m.error("The type '"+z+"' cannot be resolved in page: "+y.id)}return A},_buildStateManager:function(z,A){var x,B,y=a.trim(z.manager).toLowerCase();if(y!=""){x=A.stateManagers[y]}else{x=A.defaultStateManagerClass}if(x){if(typeof x=="function"){B=new x(null,A)}else{m.error("The manager '"+y+"' in "+z.id+" cannot create a valid state manager")}}else{m.error("The manager '"+y+"' cannot be resolved in: "+z.id)}return B}};var w={init:function(){var B=this.AbstractMaster=function(E,F,G,H){var D;this.context=E;this.request=F;this.session=G;this.stateManager=H;this.isCleared=false;if(this.context.mediator){D=a.find(this.context.mediator);if(typeof D=="function"){this.fMediator=D}}};B.prototype={display:function(){var D;m.info("Displaying "+this.context.id+" with target "+this.context.target);this.onDisplay(this);D=a.trim(this.context.container);if(D!=""){this.container=this.session.selector(this.context.container,this.session.root);if(this.container==null){m.error("Invalid container for page "+this.context.id+": "+this.context.container)}}},destroy:function(){m.info("Destroying "+this.context.id);if(this.mediator&&typeof this.mediator.destroy=="function"){this.mediator.destroy()}if(this.stateManager){this.stateManager.destroy()}},clear:function(){m.info("Clearing "+this.context.id);this.onClear(this);if(this.stateManager){this.stateManager.setState(v.STATE_OUT)}},init:function(){m.debug("Initializing "+this.context.id);if(this.target){l.apply(this.target,this.context.propContexts,this.session);a.merge(this.target,this.request.params);this.onCreate(this);if(this.stateManager){this.stateManager.target=this.target;e.observe(this.stateManager,"onStateChange",this.onStateChange,this);this.stateManager.setState(v.STATE_IN)}}if(this.fMediator){this.mediator=new this.fMediator(this.target);l.apply(this.mediator,this.context.propContexts,this.session);a.merge(this.mediator,this.request.params);if(typeof this.mediator.init=="function"){this.mediator.init()}}this.onInit(this)},onStateChange:function(E,D){if(D==v.STATE_IN){this.onIn(this)}else{if(D==v.STATE_ON){this.onOn(this)}else{if(D==v.STATE_OUT){this.onOut(this)}else{if(D==v.STATE_OFF){this.onOff(this);this.destroy()}}}}},onDisplay:function(D){},onClear:function(D){},onCreate:function(D){},onInit:function(D){},onIn:function(D){},onOn:function(D){},onOut:function(D){},onOff:function(D){}};var A=this.DomMaster=this.createViewMaster({display:function(){m.debug("DomMaster display: "+this.context.id);this.target=this.session.selector(this.context.target);if(this.target==null){m.error("Invalid target for page "+this.context.id+": "+this.context.target);return}if(this.cloneDom){this.target=this.target.cloneNode(true);this.container.appendChild(this.target)}this.originalDisplay=this._getStyle(this.target,"display");this.originalVisibility=this._getStyle(this.target,"visibility");if(this.originalDisplay=="none"){this.target.style.display="inherit"}if(this.originalVisibility=="hidden"){this.target.style.visibility="visible"}this.init()},destroy:function(){m.debug("DomMaster destroy: "+this.context.id);this.target.style.display=this.originalDisplay;this.target.style.visibility=this.originalVisibility;if(this.cloneDom){this.container.removeChild(this.target)}},_getStyle:function(G,E){var F,D;if(G.currentStyle){F=G.currentStyle[E]}else{if(i.getComputedStyle){D=i.getComputedStyle(G,null);if(D){F=D.getPropertyValue(E)}}}return F}},B);var C=this.DomCloneMaster=this.createViewMaster({cloneDom:true},A);var z=this.LoaderMaster=this.createViewMaster({display:function(){m.debug("LoaderMaster display");this.loader=new g();this.loader.load(this.context.target,this.onLoaded,this)},destroy:function(){m.debug("LoaderMaster destroy");this.container.innerHTML=""},onLoaded:function(D){m.debug("LoaderMaster received content");this.target=D.responseText;this.container.innerHTML=this.target;this.init()}},B);var y=this.BuilderMaster=this.createViewMaster({display:function(){m.debug("BuilderMaster display");this.fConstructor=a.find(this.context.target);if(typeof this.fConstructor!="function"){m.error("Invalid target for page "+this.context.id+": "+this.context.target);return}this.builder=new this.fConstructor();this.target=this.builder.build();this.container.appendChild(this.target);this.init();if(typeof this.builder.init=="function"){this.builder.init()}},destroy:function(){m.debug("BuilderMaster destroy");if(typeof this.builder.destroy=="function"){this.builder.destroy()}if(this.target){this.container.removeChild(this.target)}},init:function(){l.apply(this.builder,this.context.propContexts,this.session);a.merge(this.builder,this.request.params)}},B);var x=this.VoidMaster=this.createViewMaster({display:function(){this.init()},clear:function(){this.destroy()}},B)},createViewMaster:function(x,y){var A,z;x=x||{};y=y||this.AbstractMaster;A=function(){y.apply(this,arguments)};A.prototype=new y(arguments);for(z in x){if(x.hasOwnProperty(z)){if(typeof x[z]=="function"&&typeof A.prototype[z]=="function"){e.observe(A.prototype,z,x[z],A)}else{A.prototype[z]=x[z]}}}return A}};var v={STATE_IN:"IN",STATE_ON:"ON",STATE_OUT:"OUT",STATE_OFF:"OFF",init:function(){var x=this.BaseIo3Manager=function(z,y){this.target=z;this.session=y;this._state=null};x.prototype={destroy:function(){},getState:function(){return this._state},setState:function(y){y=y.toUpperCase();if(y!=v.STATE_IN&&y!=v.STATE_ON&&y!=v.STATE_OUT&&y!=v.STATE_OFF){m.warn("Unknown state, returning without changing state for target "+this.target);return}if(y!=this._state){this._state=y;this._changeState()}},doIn:function(){this.setState(v.STATE_ON)},doOn:function(){},doOut:function(){this.setState(v.STATE_OFF)},doOff:function(){},_changeState:function(){this.onStateChange(this.target,this._state);if(this._state==v.STATE_IN){this.doIn()}else{if(this._state==v.STATE_ON){this.doOn()}else{if(this._state==v.STATE_OUT){if(this.target!=null){this.doOut()}else{m.info("target is null when trying to set state to OUT, setting state to OFF instead of calling doOut to avoid errors.");this._state=v.STATE_OFF}}else{if(this._state==v.STATE_OFF){this.doOff()}}}}},onStateChange:function(z,y){}}},createStateManager:function(){var A,z=typeof arguments[0]=="object",x=z?arguments[0]:{},y=z?arguments[1]:arguments[2];y=y||this.BaseIo3Manager;if(!z){if((typeof arguments[0]=="function")&&(typeof arguments[1]=="function")){x.doIn=arguments[0];x.doOut=arguments[1]}else{m.warn("Malformed call to createStateManager - either createStateManager(conf, [parent]) or createStateManager(doIn, doOut, [parent]) are allowed.")}}A=function(){y.apply(this,arguments)};A.prototype=new y();a.merge(A.prototype,x);return A}};var p=function(x,y,z){this.id=x.id;this.context=x;this.request=y;this.session=z};var d={createCommand:function(x,y,z){var A=new p(x,y,z);A.master=this._buildMaster(x,y,z);return A},_buildMaster:function(y,B,C){var x,A,z=a.trim(y.type).toLowerCase();if(z!=""){x=C.commandMasters["_"+z]}else{x=C.defaultCommandMasterClass}if(x){if(typeof x=="function"){A=new x(y,B,C)}else{m.error("The type "+z+" in "+y.id+" cannot create a new command")}}else{m.error("The type "+z+" cannot be resolved in command: "+y.id)}return A}};var r={init:function(){var y=this.AbstractMaster=function(z,A,B){this.context=z;this.request=A;this.session=B;this.isExecuted=false};y.prototype={execute:function(){m.debug("Initializing "+this.context.id)}};var x=this.FunctionMaster=this.createCommandMaster(function(){var B=a.find(this.context.target),z=[],A=a.mix(this.context.props,this.request.params);l.resolve(A,this.session);if(A._args&&A._args.length){z=A._args.slice(0)}if(!a.isEmpty(A)){z.push(A)}if(typeof B=="function"){B.apply(null,z)}else{m.warn("There is no function to execute for command '"+this.context.id+"' and target '"+this.context.target+"'.")}this.isExecuted=true},y)},createCommandMaster:function(z,A){var y,B=typeof z=="object",x=B?z:{};A=A||this.AbstractMaster;if(!B){if(typeof arguments[0]=="function"){x.execute=z}else{m.warn("Malformed call to createCommandMaster - either createCommandMaster(conf, [parent]) or createCommandMaster(fExecute, [parent]) are allowed.")}}y=function(){A.apply(this,arguments)};y.prototype=new A();a.merge(y.prototype,x);return y}};var c={parse:function(y,z){var x={};x.propContexts=this._parsePropContexts(y.getElementsByTagName("zumo")[0],z);x.props=this._getPropsFromPropContexts(x.propContexts);x.includes=this._parseIncludes(y,z);x.views=this._parseViews(y,z);x.commands=this._parseCommands(y,z);return x},_parseIncludes:function(x,D){var A=x.getElementsByTagName("include"),B,z=[],C,y;for(y=0;y<A.length;y++){B=A[y];C=B.attributes.getNamedItem("target").nodeValue;if(!a.isEmpty(C)){z.push(C)}}return z},_parseViews:function(B,D){var z=B.getElementsByTagName("views"),G={pages:[],blocks:[]},E,F,y,C,A,x;if(z.length>1){m.warn("There can only be zero or one views nodes on the XML configuration, there were "+z.length+" views nodes found");return null}else{if(z.length==0){m.info("No views to parse");return null}}E="page";F=z[0].getElementsByTagName(E);for(x=0;x<F.length;x++){C=this._parsePageBlock(F[x],D);if(C){C.node=E;this._mergeAttributes(C,F[x],["parent"]);C.parentId=C.parent;C.parent=null;C.children=[];G.pages.push(C)}}E="block";y=z[0].getElementsByTagName(E);for(x=0;x<y.length;x++){A=this._parsePageBlock(y[x],D);if(A){A.node=E;G.blocks.push(A)}}return G},_parsePageBlock:function(x,z){var y={},B,A;this._mergeAttributes(y,x,["id","type","mediator","target","container","manager","title"]);B=x.attributes.getNamedItem("depends");if(B){A=B.nodeValue.replace(/\s/g,"").split(",");if(!(A.length==1&&A[0]=="")){y.depends=A}}y.propContexts=this._parsePropContexts(x,z);y.props=this._getPropsFromPropContexts(y.propContexts);y.handlers=this._parseHandlers(x,z);return y},_parseCommands:function(y,D){var B=y.getElementsByTagName("commands"),x=[],C,A,z;if(B.length>1){m.warn("There can only be zero or one commands nodes on the XML configuration, there were "+B.length+" commands nodes found")}else{if(B.length==0){m.info("No commands to parse")}else{C=B[0].getElementsByTagName("command");for(z=0;z<C.length;z++){A={};this._mergeAttributes(A,C[z],["id","type","target"]);A.propContexts=this._parsePropContexts(C[z],D);A.props=this._getPropsFromPropContexts(A.propContexts);A.handlers=this._parseHandlers(C[z],D);x.push(A)}}}return x},_parsePropContexts:function(x,C){var z=a.getChildren(x,"prop"),B=[],A,y;for(y=0;y<z.length;y++){A=this._parsePropContext(z[y],C);if(A){B.push(A)}}return B},_parsePropContext:function(z,B){var A={},x,y;this._mergeAttributes(A,z,["name","target"]);x=z.attributes.getNamedItem("decorators");if(x){y=x.nodeValue.replace(/\s/g,"").split(",");if(!(y.length==1&&y[0]=="")){A.decorators=y}}A.value=this._parsePropValue(z,B);return A},_parsePropValue:function(D,F){var x={},A,B,y,E,C,z;this._mergeAttributes(x,D,["name","value"]);A=a.getChildren(D).length>0;B=a.getChildren(D,"item");y=a.getChildren(D,"prop");if(A){if(x.value){m.warn("Both value attribute and children nodes found on prop: '"+x.name+"'. Only value attribute will be used.")}else{if(y.length>0){if(B.length>0){m.warn("Both prop and item nodes found on prop: '"+x.name+"'. Only prop nodes will be used.")}x.value={};for(z=0;z<y.length;z++){E=y[z];C=E.attributes.getNamedItem("name").nodeValue;x.value[C]=this._parsePropValue(E)}}else{if(B.length>0){x.value=[];for(z=0;z<B.length;z++){x.value.push(this._parsePropValue(B[z]))}}}}}else{if(x.value){if(D.firstChild&&a.trim(D.firstChild.nodeValue)!=""){m.warn("Both value attribute and text content found on prop: '"+x.name+"'. Only value attribute will be used.")}}else{if(D.firstChild){x.value=D.firstChild.nodeValue}else{x.value=""}}}return x.value},_getPropsFromPropContexts:function(z){var y={},x;for(x=0;x<z.length;x++){y[z[x].name]=z[x].value}return y},_mergeAttributes:function(C,z,B){var y,x,A;for(y=0;y<B.length;y++){x=B[y];if(x&&a.trim(x)!=""){A=z.attributes.getNamedItem(x);if(A){C[x]=A.nodeValue}}}},_parseHandlers:function(z,C){var x=z.getElementsByTagName("handler"),y=[],B,A;for(A=0;A<x.length;A++){B=this._parseHandler(x[A],C);if(B){y.push(B)}}return y},_parseHandler:function(x,z){var y={};m.debug(x);this._mergeAttributes(y,x,["type","target","priority","class","at","action","priority"]);y.params=this._parseParams(x,z);return y},_parseParams:function(y,B){var A=y.getElementsByTagName("param"),C=[],x,z;for(z=0;z<A.length;z++){x=this._parseParam(A[z],B);if(x){C.push(x)}}return C},_parseParam:function(y,z){var x={};this._mergeAttributes(x,y,["name","value"]);m.debug(y);if(!x.value){x.value=y.firstChild.nodeValue}return x}};var f=function(x){this.app=x;this._activeHandlers=[];this._bindings=[];this.updateBindings=false;this.hasRegistered=false};f.prototype={registerHandlers:function(){var C=this.app.getPageContexts(),B=this.app.getBlockContexts(),D=this.app.getCommandContexts(),y,x,A,z;if(this.hasRegistered){this.unregisterHandlers()}for(z=0;z<C.length;z++){y=C[z];this._registerHandlersFromContext(y,"page")}for(z=0;z<B.length;z++){x=B[z];this._registerHandlersFromContext(x,"block")}for(z=0;z<D.length;z++){A=D[z];this._registerHandlersFromContext(A,"command")}this.hasRegistered=true;this.updateBindings=this._updateBindings();e.observe(this.app,"onPageInit",this.onViewInit,this);e.observe(this.app,"onBlockInit",this.onViewInit,this)},unregisterHandlers:function(){var x;while(this._activeHandlers.length>0){x=this._activeHandlers.pop();this._removePageBlockHandlerAction(x)}e.ignore(this.app,"onPageInit",this.onViewInit);e.ignore(this.app,"onBlockInit",this.onViewInit)},_registerHandlersFromContext:function(z,x){var A,y;for(y=0;y<z.handlers.length;y++){A={handlerContext:z.handlers[y],context:z,contextType:x,f:this._createHandlerAction(z.handlers[y],z,x)};this._activeHandlers.push(A)}},_createHandlerAction:function(z,y,x){if(x=="page"){return this._createPageHandlerAction(z,y)}else{if(x=="block"){return this._createBlockHandlerAction(z,y)}else{if(x=="command"){return this._createCommandHandlerAction(z,y)}else{m.warn("Could not create handler action - the context type is neither a page or a block");return null}}}},_createPageHandlerAction:function(y,x){var B=this.app,A,z=function(){var D=arguments[1],C=B.getCurrentPage(),E;if(!y.at||y.at==""||y.at==C.id){if(C&&x.id==C.id){m.debug("Handler "+y.type+"trigger when already at "+C.id);t.apply(C.master.target,y.params,this.session)}else{E=a.delegate(B.go,B,x.id,D);setTimeout(E,10)}}};if(y.action=="go"||y.action=="go"||y.action=="call"||y.action==""||y.action==null){A=z}else{m.warn("Could not resolve handler action: "+y.action)}this._registerBinding(y.type,A,y.target);return A},_createBlockHandlerAction:function(z,x){var C=this.app,B,y=function(){var E=arguments[1],D;if(!z.at||z.at==""||z.at==C.getCurrentPage().id){D=C.getDisplayedBlock(x.id);if(D){t.apply(D.master.target,z.params,this.session)}else{C.displayBlock(x.id,E)}}},A=function(){if(!z.at||z.at==""||z.at==C.getCurrentPage().id){C.clearBlock(x.id)}};if(z.action=="clear"||z.action=="clearBlock"){B=A}else{if(z.action=="displayBlock"||z.action=="display"||z.action=="call"||z.action==""||z.action==null){B=y}else{m.warn("Could not resolve handler action: "+z.action)}}this._registerBinding(z.type,B,z.target);return B},_createCommandHandlerAction:function(x,y){var B=this.app,z,A=function(){var C=B.getCurrentPage(),D;if(!x.at||x.at==""||x.at==C.id){D=arguments[1];B.execute(y.id,D)}};if(x.action=="execute"||x.action==""||x.action==null){z=A}else{m.warn("Could not resolve handler action: "+x.action)}this._registerBinding(x.type,z,x.target);return z},_removePageBlockHandlerAction:function(x){if(x.contextType=="page"){this._removePageHandlerAction(x)}else{if(x.contextType=="block"){this._removeBlockHandlerAction(x)}else{m.warn("Could not remove handler action - the context type is neither a page or a block")}}},_removePageHandlerAction:function(x){},_removeBlockHandlerAction:function(x){},_registerBinding:function(y,x,z){this._bindings.push({type:y,f:x,target:z})},_bindHandler:function(y,x,z){m.info("There is no handler binder implemented");return true},_unbindHandler:function(y,x,z){m.info("There is no handler unbinder implemented");return true},_updateBindings:function(z){var A,y,x=false;for(y=0;y<this._bindings.length;y++){A=this._bindings[y];if(!z||A.target){this._unbindHandler(A.type,A.f,A.target);if(!this._bindHandler(A.type,A.f,A.target)){x=true}}}return x},onViewInit:function(){this._updateBindings(true)}};var s={Utils:a,ExpressionResolver:h,Loader:g,ViewMasters:w,StateManagers:v,_VIEW_MASTERS:{dom:"DomMaster",domclone:"DomCloneMaster",loader:"LoaderMaster",builder:"BuilderMaster",_void:"VoidMaster"},_DEFAULT_VIEW_TYPE:"dom",_STATE_MANAGERS:{base:"BaseIo3Manager"},_DEFAULT_STATE_MANAGER:"base",_COMMAND_MASTERS:{_function:"FunctionMaster"},_DEFAULT_COMMAND_TYPE:"_function",_DEFAULT_PROP_NAME:"innerHTML",_PARAM_NAME_CALLER:"_caller",log:m,root:null,props:null,session:{viewMasters:{},defaultViewMasterClass:null,stateManagers:{},defaultStateManagerClass:null,commandMasters:{},defaultCommandMasterClass:null,selector:q.select,confParsers:[]},_isInit:false,_conf:null,_confTargets:[],_params:null,_currentPage:null,_displayedPage:null,_displayedBlocks:[],_handlerManager:null,startup:function(){this["goto"]=this.go;this._VIEW_MASTERS["void"]=this._VIEW_MASTERS._void;m.prefix=u?u.toUpperCase()+" - ":"";this._initViewMasters();this._initStateManagers();this._initCommandMasters()},init:function(){var x,y,z;if(typeof arguments[0]=="string"){y=arguments[0];z=arguments[1]}else{if(arguments.length>1){x=arguments[0];y=arguments[1];z=arguments[2]}}x=x||document;y=y||x;this._params=z||{};this.root=x;m.info("Initializing Zumo object with root "+x);this._displayedBlocks=[];this.session.id=this._params.id||this._createSessionId();this.session.root=x;this.session.defaultPropName=this._DEFAULT_PROP_NAME;this.session.confParsers.push(this._parseConf);this._handlerManager=new f(this);this._initConf(y);m.info("New Zumo session created with id: "+this.session.id)},destroy:function(){m.debug("Destroying Zumo object");this.session={};this.root=this._conf=this._params=this._currentPage=this._displayedPage=null},isInit:function(){return this._isInit},go:function(B,A){var x,y,z;m.info("Going to page "+B);if(!this.isInit()){m.warn("Cannot go "+B+" - Zumo is not yet initalized");return}A=A||{};if(this._currentPage!=null){m.debug("currentPage id = "+this._currentPage.id);if(B==this._currentPage.context.id){m.info("No page to go - we are already in "+B);return}}else{m.debug("currentPage is null")}x=this.getPageContext(B);if(!x||typeof x!=="object"){m.error("No page context found with id: "+B);return}y={id:B,params:A,referrer:this._currentPage};z=n.createPage(x,y,this.session);this.onPageRequest(x,y);if(z.master==null){return}e.observe(z.master,"onDisplay",this.onPageDisplay,this);e.observe(z.master,"onClear",this.onPageClear,this);e.observe(z.master,"onCreate",this.onPageCreate,this);e.observe(z.master,"onInit",this.onPageInit,this);e.observe(z.master,"onIn",this.onPageIn,this);e.observe(z.master,"onOn",this.onPageOn,this);e.observe(z.master,"onOut",this.onPageOut,this);e.observe(z.master,"onOff",this.onPageOff,this);if(this._currentPage!=null){this._currentPage.master.clear()}this._currentPage=z;z.master.display();this._displayedPage=z;this._displayDepends(z)},getPageContext:function(A){var x,y,z;if(!this.isInit()){m.warn("Cannot get page context ("+A+")- Zumo is not yet initalized");return null}if(this._conf.views==null){m.info("Cannot get page context since there are no views configured");return null}for(y=0;y<this._conf.views.pages.length;y++){z=this._conf.views.pages[y];if(z.id==A){x=z;break}}return x},getPageContexts:function(){return this._conf.views.pages},getPageContextsAt:function(A){var x=[],z,y;for(z=0;z<this._conf.views.pages.length;z++){y=this._conf.views.pages[z];if(y.level==A){x.push(y)}}return x},getDisplayedPage:function(){return this._displayedPage},getCurrentPage:function(){return this._currentPage},getPageLevel:function(z){var y=0,x=this.getPageContext(z);if(x.parentId!=null){y=this.getPageLevel(x.parentId)+1}return y},displayBlock:function(B,A){var z,y,x;m.info("Displaying block "+B);if(!this.isInit()){m.warn("Cannot display "+B+" - Zumo is not yet initalized");return}A=A||{};z=this.getDisplayedBlock(B);if(z){if(A[this._PARAM_NAME_CALLER]){z.addCaller(A[this._PARAM_NAME_CALLER])}else{z.addCaller(z.id)}m.info("No block to display - the block is already displayed: "+B)}else{x=this.getBlockContext(B);if(!x||typeof x!=="object"){m.error("No block context found with id: "+B);return}y={id:B,params:A};z=n.createBlock(x,y,this.session);this.onBlockRequest(x,y);if(z.master==null){return}e.observe(z.master,"onDisplay",this.onBlockDisplay,this);e.observe(z.master,"onClear",this.onBlockClear,this);e.observe(z.master,"onCreate",this.onBlockCreate,this);e.observe(z.master,"onInit",this.onBlockInit,this);e.observe(z.master,"onIn",this.onBlockIn,this);e.observe(z.master,"onOn",this.onBlockOn,this);e.observe(z.master,"onOut",this.onBlockOut,this);e.observe(z.master,"onOff",this.onBlockOff,this);if(A[this._PARAM_NAME_CALLER]){z.request.caller=A[this._PARAM_NAME_CALLER]}else{z.request.caller=z.id}z.addCaller(z.request.caller);z.master.display();this._addDisplayedBlock(z);this._displayDepends(z)}},clearBlock:function(y){m.info("Clearing block "+y);var x=this.getDisplayedBlock(y);if(!x){m.info("There is no block to clear with id "+y);return}if(x.master.isCleared){m.info("The block is already being cleared: "+y);return}x.master.clear();this._removeDisplayedBlock(y);this._clearDepends(x)},getBlockContext:function(A){var x,z,y;if(!this.isInit()){m.warn("Cannot get block context ("+A+")- Zumo is not yet initalized");return null}if(this._conf.views==null){m.info("Cannot get block context since there are no views configured");return null}for(z=0;z<this._conf.views.blocks.length;z++){y=this._conf.views.blocks[z];if(y.id==A){x=y;break}}return x},getBlockContexts:function(){return this._conf.views.blocks},getDisplayedBlock:function(z){var y,x;for(x=0;x<this._displayedBlocks.length;x++){if(this._displayedBlocks[x].id==z){y=this._displayedBlocks[x];break}}return y},getDisplayedBlocks:function(x){return this._displayedBlocks},registerViewMaster:function(x,y){if(a.trim(x)==""){m.warn("Cannot register a view master with an empty name");return}x=x.toLowerCase();if(typeof y!="function"){m.warn("Cannot register view master with name "+x+" - master is not a function");return}if(this.session.viewMasters[x]==null){this.session.viewMasters[x]=y}else{m.warn("Cannot register view master with name "+x+" - there is already registered a master with that name")}},unregisterViewMaster:function(x){this.session.viewMasters[x]=null},createViewMaster:function(){var x=arguments[0],y=w.createViewMaster.apply(w,[].slice.call(arguments,1));this.registerViewMaster(x,y);return y},registerStateManager:function(x,y){if(a.trim(x)==""){m.warn("Cannot register a state manager with an empty name");return}x=x.toLowerCase();if(typeof y!="function"){m.warn("Cannot register state manager with name "+x+" - manager is not a function");return}if(this.session.stateManagers[x]==null){this.session.stateManagers[x]=y}else{m.warn("Cannot register state manager with name "+x+" - there is already registered a manager with that name")}},unregisterStateManager:function(x){this.session.stateManagers[x.toLowerCase()]=null},createStateManager:function(){var x=arguments[0],y=v.createStateManager.apply(v,[].slice.call(arguments,1));this.registerStateManager(x,y);return y},execute:function(B,A){var x,y,z;m.info("Executing command "+B);if(!this.isInit()){m.warn("Cannot execute "+B+" - Zumo is not yet initalized");return}A=A||{};x=this.getCommandContext(B);if(!x||typeof x!=="object"){m.error("No command context found with id: "+B);return}y={id:B,params:A};z=d.createCommand(x,y,this.session);z.master.execute(y)},getCommandContexts:function(){return this._conf.commands},getCommandContext:function(A){var y,x,z;if(!this.isInit()){m.warn("Cannot get command context ("+A+")- Zumo is not yet initalized");return null}if(this._conf.commands==null||this._conf.commands.length==0){m.info("Cannot get block context since there are no commands configured");return null}for(x=0;x<this._conf.commands.length;x++){z=this._conf.commands[x];if(z.id==A){y=z;break}}return y},registerCommandMaster:function(x,y){if(a.trim(x)==""){m.warn("Cannot register a command master with an empty name");return}x=x.toLowerCase();if(typeof y!="function"){m.warn("Cannot register command master with name "+x+" - command is not a function");return}if(this.session.commandMasters[x]==null){this.session.commandMasters[x]=y}else{m.warn("Cannot register command master with name "+x+" - there is already registered a master with that name")}},unregisterCommandMaster:function(x){this.session.commandMasters[x]=null},createCommandMaster:function(){var x=arguments[0],y=r.createCommandMaster.apply(r,[].slice.call(arguments,1));this.registerCommandMaster(x,y);return y},observe:function(z,y,x){e.observe(this,z,y,x)},ignore:function(y,x){e.ignore(this,y,x)},_initConf:function(x){var y;if(typeof x=="string"){m.info("Initializing with remote configuration: "+x);if(this._confTargets.length==0){this._confTargets.push({target:x,isParsed:false})}y=new g();y.load(x,this._onConfLoaded,this,[x])}else{this._processConf(x)}},_initViewMasters:function(){var y,x;w.init();for(y in this._VIEW_MASTERS){x=this._VIEW_MASTERS[y];this.registerViewMaster(y,w[x])}this.session.defaultViewMasterClass=this.session.viewMasters[this._DEFAULT_VIEW_TYPE]},_initStateManagers:function(){var y,x;v.init();for(y in this._STATE_MANAGERS){x=this._STATE_MANAGERS[y];this.registerStateManager(y,v[x])}this.session.defaultStateManagerClass=this.session.stateManagers[this._DEFAULT_STATE_MANAGER]},_initCommandMasters:function(){var y,x;r.init();for(y in this._COMMAND_MASTERS){x=this._COMMAND_MASTERS[y];this.registerCommandMaster(y,r[x])}this.session.defaultCommandMasterClass=this.session.commandMasters[this._DEFAULT_COMMAND_TYPE]},_createSessionId:function(){if(i._nZumo==null){i._nZumo=0}i._nZumo++;return u+i._nZumo},_addDisplayedBlock:function(x){if(!this.getDisplayedBlock(x.id)){this._displayedBlocks.push(x)}},_removeDisplayedBlock:function(y){var x;for(x=0;x<this._displayedBlocks.length;x++){if(this._displayedBlocks[x].id==y){break}}this._displayedBlocks.splice(x,1)},_displayDepends:function(A){var x,B,y,z;m.debug("Displaying depends for "+A.id);if(!A){return}x=this._getFlattenedDepends(A);for(z=0;z<x.length;z++){B={};B[this._PARAM_NAME_CALLER]=A.id;this.displayBlock(x[z],B)}if(A.context.node=="page"){y=A.request.referrer;if(y!=null){this._clearDepends(y)}}},_clearDepends:function(z){var x,y,A;m.debug("Clearing depends for "+z.id);if(!z){return}x=this._getFlattenedDepends(z);for(y=0;y<x.length;y++){A=this.getDisplayedBlock(x[y]);if(!A){continue}A.removeCaller(z.id);if(A.getCallers().length==0){this.clearBlock(A.id)}}},_getFlattenedDepends:function(C,A){var y=A||[],B=C.depends,z,D,x;if(!B&&C.context){B=C.context.depends}if(!B){return[]}if(!Array.indexOf){Array.prototype.indexOf=function(F){for(var E=0;E<this.length;E++){if(this[E]==F){return E}}return -1}}for(z=0;z<B.length;z++){D=B[z];if(y.indexOf(D)!=-1){continue}y.push(D);x=this.getBlockContext(D);this._getFlattenedDepends(x,y)}return y},_processConf:function(z){var x,A,y;for(x=0;x<this.session.confParsers.length;x++){A=this.session.confParsers[x];if((typeof A=="function")&&(y=A(z))){break}}if(y.includes&&y.includes.length>0){for(x=0;x<y.includes.length;x++){this._addConfTarget(y.includes[x])}}if(this._conf){a.mergeDeep(this._conf,y)}else{this._conf=y}if(this._getPendingConfTargets().length==0){this.props=this._conf.props;a.mergeDeep(this.props,this._params);this._handlerManager.registerHandlers();this._isInit=true;this._processParenting();this.onConfLoaded()}},_addConfTarget:function(z){var x,y;for(x=0;x<this._confTargets.length;x++){if(z==this._confTargets[x].target){m.warn("Duplicated conf target '"+z+"', ignoring...");y=true;break}}if(!y){this._confTargets.push({target:z,isParsed:false});this._initConf(z)}},_markConfTarget:function(y){var x;for(x=0;x<this._confTargets.length;x++){if(y==this._confTargets[x].target){this._confTargets[x].isParsed=true;break}}},_getPendingConfTargets:function(){var x,y=[];for(x=0;x<this._confTargets.length;x++){if(!this._confTargets[x].isParsed){y.push(this._confTargets[x].target)}}return y},_processParenting:function(){var x=this.getPageContexts(),z,y,A;for(z=0;z<x.length;z++){y=x[z];if(y.parentId){A=this.getPageContext(y.parentId);if(!A){m.warn("Parent node '"+y.parentId+"' cannot be found for '"+y.id+"'");continue}if(!y.parent){y.parent=A;A.children.push(y);y.level=this.getPageLevel(y.id)}}}},_parseConf:function(x){return c.parse(x,this.session)},onConfLoaded:function(){},onPageRequest:function(x,y){},onPageDisplay:function(x){},onPageClear:function(x){},onPageCreate:function(x){},onPageInit:function(x){},onPageIn:function(x){},onPageOn:function(x){},onPageOut:function(x){},onPageOff:function(x){},onBlockRequest:function(x,y){},onBlockDisplay:function(x){},onBlockClear:function(x){},onBlockCreate:function(x){},onBlockInit:function(x){},onBlockIn:function(x){},onBlockOn:function(x){},onBlockOut:function(x){},onBlockOff:function(x){},_onConfLoaded:function(x,y){m.info("Conf was loaded, target = "+y);this._markConfTarget(y);this._processConf(x.responseXML)}};var j={addHandlerBinder:function(y,z,x){f.prototype._bindHandler=y;f.prototype._unbindHandler=z},setSelector:function(x){if(x&&typeof x=="function"){s.session.selector=x}else{m.warn("Could not create a selector function from "+x)}},addConfParser:function(x){s.session.confParsers.unshift(x)}};s.startup();i.Zumo=s;i.ZumoExt=j;i.ZumoAgent=e})(this);(function(f){if(!Zumo||!ZumoExt){return}var c=function(j){var i=$("*[id]",j.target),l=$("*[for]",j.target),h=$("*[name]",j.target),k="z-";i.each(function(){var o=$(this),m="id",p=o.attr(m),n=p.indexOf(k);if(n==0){o.attr(m,p.substr(k.length))}});l.each(function(){var o=$(this),m="for",p=o.attr(m),n=p.indexOf(k);if(n==0){o.attr(m,p.substr(k.length))}});h.each(function(){var o=$(this),m="name",p=o.attr(m),n=p.indexOf(k);if(n==0){o.attr(m,p.substr(k.length))}})};Zumo.observe("onPageCreate",c);Zumo.observe("onBlockCreate",c);var e=function(j,i,k){k=k||$("body");var h=$(k);if(h.length>0){$(k).on(j,i);return true}else{return false}};var d=function(j,i,k){k=k||f;var h=$(k);if(h.length>0){h.off(j,i);return true}else{return false}};ZumoExt.addHandlerBinder(e,d,true);var b=function(h,i){return $(h,i)[0]};ZumoExt.setSelector(b);var a=function(h,i,j,k){Zumo.ViewMasters.AbstractMaster.call(this,h,i,j,k)};a.prototype={display:function(){Zumo.ViewMasters.AbstractMaster.prototype.display.apply(this,arguments);var h=this;this.$container=$(this.container);this.$container.load(this.context.target,function(){h.init()})},destroy:function(){Zumo.ViewMasters.AbstractMaster.prototype.destroy.apply(this,arguments);this.$container.clear()},init:function(){Zumo.ViewMasters.AbstractMaster.prototype.init.apply(this,arguments)},clear:function(){Zumo.ViewMasters.AbstractMaster.prototype.clear.apply(this,arguments)},onStateChange:function(i,h){Zumo.ViewMasters.AbstractMaster.prototype.onStateChange.apply(this,arguments)},onDisplay:function(h){},onClear:function(h){},onInit:function(h){},onIn:function(h){},onOn:function(h){},onOut:function(h){},onOff:function(h){}};Zumo.registerViewMaster("_$loader",a);(function(i){var h=Zumo.createStateManager("$fade",{duration:"slow",doIn:function(){var k=this,j=$(this.target);j.hide();j.fadeIn(this.duration,function(){k.setState(Zumo.StateManagers.STATE_ON)})},doOut:function(){var j=this;$(this.target).fadeOut(this.duration,function(){j.setState(Zumo.StateManagers.STATE_OFF)})}});Zumo.createStateManager("$fadeSlow",{duration:"slow"},h);Zumo.createStateManager("$fadeFast",{duration:"fast"},h)})(f);var g=function(k){var i={},j,h;if(typeof k!="object"||typeof k.getElementsByTagName!="function"||(k.firstChild&&k.firstChild.nodeName=="zumo")){return null}j=function(r,n,q){var m,l,p;for(m=0;m<q.length;m++){l=q[m];p=$(n).attr("data-"+l);if(p){r[l]=p}}};h=function(q){var t=$(q),m={},n,o,s,l,r,u,p;j(m,q,["type","mediator","container","manager","title"]);m.target=q;n=t.attr("data-depends");if(n){m.depends=n.replace(/\s*,\s*|\s+/g,",").split(",")}else{m.depends=[]}m.handlers=[];o=t.attr("data-handlers");if(o){s=o.split(",");for(p=0;p<s.length;p++){u={};l=s[p];r=l.split("@");if(r.length==2){u.at=Zumo.Utils.trim(r[1]);l=r[0]}else{if(r.length>2){}}r=l.split(":");if(r.length==1){u.type=r[0]}else{if(r.length==2){u.target=r[0];u.type=r[1]}else{}}m.handlers.push(u)}}return m};i.views={pages:[],blocks:[]};i.commands=[];$("*[data-page]",k).each(function(){var l=h(this);l.id=$(this).attr("data-page");l.node="page";i.views.pages.push(l)});$("*[data-block]",k).each(function(){var l=h(this);l.id=$(this).attr("data-block");l.node="block";i.views.blocks.push(l)});return i};ZumoExt.addConfParser(g)})(this);