(function(j){var v="Zumo",b="0.3";var e={_registry:[],observe:function(){var B=this._buildRequest.apply(this,arguments);if(!B.success){return}var z=B.o,E=B.fName,G=B.hook,I=B.thisContext,H=B.priority,A,D,F,C,y;A=z[E];if(A!=undefined&&(typeof A!="function")){this._warn('The provided function name "'+E+'" does not reference a function but a '+(typeof z[E])+" - this member should be changed at runtime to a function in order to avoid unexpected results")}D=false;for(C=0;C<this._registry.length;C++){y=this._registry[C];if(y.o===z&&y.fName==E){F=y;D=true;break}}if(!D){F=this._createProxy(z,E)}this._addHook(F,G,I,H)},ignore:function(){var B=this._buildRequest.apply(this,arguments);if(!B.success){return}var F=B.o,D=B.fName,C=B.hook,A,z,E,y;for(z=0;z<this._registry.length;z++){E=this._registry[z];if(E.o===F&&E.fName==D){for(y=0;y<E.hooks.length;y++){if(E.hooks[y].f===C){A=true;E.hooks.splice(y,1);break}}}}if(!A){this._warn("There is no matching function to remove on "+D)}},_buildRequest:function(){if(typeof arguments[0]!="object"&&typeof arguments[0]!="string"){this._warn("The first parameter to observe/ignore should be either an object (that holds the function to be observed/ignored) or a string (the function name to be obeserved/ignored, taking window as the default object), no hook will be processed");return}var B=(typeof arguments[0]=="string"),A={o:B?j:arguments[0],fName:B?arguments[0]:arguments[1],hook:B?arguments[1]:arguments[2],thisContext:null,priority:0,success:true},z,y;if(arguments.length>(B?2:3)){z=B?(arguments[2]):(arguments[3]);y=B?(arguments[3]):(arguments[4]);if(z&&typeof z=="object"){A.thisContext=z;if(y&&typeof y=="number"){A.priority=y}}else{if(typeof z=="number"){A.priority=z}}}if(typeof A.o!="object"){this._warn("No object to observe, no hook will be processed");A.success=false}else{if(typeof A.fName!="string"){this._warn("There was no function name string provided to observe, no hook will be processed");A.success=false}else{if(typeof A.hook!="function"){this._warn("There was no hook function provided to observe, no hook will be processed");A.success=false}}}return A},_createProxy:function(B,A){var z=B[A],y={o:B,fName:A,hooks:[]};this._addHook(y,z,0);y.original=z;this._registry.push(y);return y},_buildProxy:function(y){y.o[y.fName]=function(){var A,z;for(z=y.hooks.length-1;z>=0;z--){A=y.hooks[z];A.f.apply(A.thisContext||this,arguments)}}},_addHook:function(C,B,G,E){if(!B){return}if(C.original===B){this._warn("You cannot observe a function to itself: "+B);return}var y=0,F=false,z,A,D;for(z=0;z<C.hooks.length;z++){A=C.hooks[z];if(A.f===B){F=true;break}if(A.priority<E){y=z+1}}if(F){this._warn("Hook already exists, will not be added: "+B)}else{D={f:B,thisContext:G,priority:E};C.hooks.splice(y,0,D)}this._buildProxy(C)},_warn:function(y){if(j.console&&typeof j.console.warn=="function"){j.console.warn(y)}}};var n={LEVELS:["error","warn","info","debug"],level:1,prefix:"",debug:function(y){if(typeof y=="string"){y=this.prefix+y}this._log(y,3)},info:function(y){this._log(this.prefix+y,2)},warn:function(y){this._log(this.prefix+y,1)},error:function(y){this._log(this.prefix+y,0)},_log:function(z,A){var y;if(!j.console){return}if(A==null){A=this.level}if(this.level>=A){y=j.console[this.LEVELS[A]];if(typeof y=="function"){y.call(j.console,z)}}}};var a={delegate:function(A,z){var y=[].slice.call(arguments,2);return function(){return A.apply(z,(arguments.length==0)?y:arguments)}},trim:function(y){y=y||"";return y.replace(/^\s+|\s+$/g,"")},ltrim:function(y){y=y||"";return y.replace(/^\s+/,"")},rtrim:function(y){y=y||"";return y.replace(/\s+$/,"")},mix:function(){var y,A,z={};for(y=0;y<arguments.length;y++){for(A in arguments[y]){if(arguments[y].hasOwnProperty(A)){z[A]=arguments[y][A]}}}return z},merge:function(){var y,A,z=arguments[0];if(z&&typeof z=="object"){for(y=1;y<arguments.length;y++){for(A in arguments[y]){if(arguments[y].hasOwnProperty(A)){z[A]=arguments[y][A]}}}}},mergeDeep:function(A,z){var y,B;if(A&&typeof A=="object"&&z&&typeof z=="object"){for(B in z){if(z[B]!==null&&z.hasOwnProperty(B)){if(typeof z[B]=="object"&&typeof A[B]=="object"){if(z[B].hasOwnProperty("length")&&A[B].hasOwnProperty("length")&&typeof A[B].concat=="function"){A[B]=A[B].concat(z[B])}else{this.mergeDeep(A[B],z[B])}}else{A[B]=z[B]}}}}},find:function(B,y){var A=B.split("."),C=y||j,z;for(z=0;z<A.length;z++){C=C[A[z]];if(!C){break}}return C},isEmpty:function(z){var y;if(z){if(typeof z=="object"){for(y in z){if(z.hasOwnProperty(y)){return false}}return true}else{if(typeof z=="string"){return a.trim(z)==""}else{return false}}}else{return true}},getChildren:function(B,y){var A=[],z,C;if(B&&B.childNodes.length){for(z=0;z<B.childNodes.length;z++){C=B.childNodes[z];if(C.nodeType==1&&(!y||C.nodeName==y)){A.push(C)}}}return A},indexOf:function(y,A){var z;if(y.length==undefined||A==null){return null}for(z=0;z<y.length;z++){if(y[z]===A){return z}}return -1},getNestedProperty:function(B,C){if(!B||typeof B!="object"||typeof C!="string"){return null}var z=B,y=C.split("."),A;for(A=0;A<y.length;A++){z=z[y[A]];if(z==null){z=null;break}}if(z==B){z=null}return z}};var r={select:function(y,z){z=document;return z.getElementById(y.substr(1))}};var g=function(){this.method="GET"};g.prototype={load:function(z,A,B,C){var D=this.onState,y=this;this.callback=A;this.callbackObject=B;this.params=C||[];if(j.XMLHttpRequest){this.xmlHttp=new XMLHttpRequest();this.xmlHttp.onreadystatechange=function(){y.onState.call(y)};this.xmlHttp.open(this.method,z,true);this.xmlHttp.send(null)}else{if(j.ActiveXObject){n.info("Loader using ActiveX");this.xmlHttp=new ActiveXObject("Microsoft.XMLHTTP");if(this.xmlHttp){this.xmlHttp.onreadystatechange=function(){y.onState.call(y)};this.xmlHttp.open(this.method,z,true);this.xmlHttp.send()}}}if(!this.xmlHttp){n.error("Loader could not create an XML HTTP object")}},onState:function(){if(this.xmlHttp.readyState==4){if(this.xmlHttp.status==200||this.xmlHttp.status==0){this.onLoaded(this.xmlHttp)}else{n.warn("The server returned an error when trying to load: "+this.xmlHttp.responseXML)}}},onLoaded:function(y){n.debug("The server returned content from Loader");var z=[];if(typeof this.callback=="function"){z.push(y);z=z.concat(this.params);this.callback.apply(this.callbackObject,z)}}};var h=function(){this.evaluators=[];this.add(function(z,y){if(typeof z!="string"){return null}return a.getNestedProperty(y,z)})};h.prototype={opening:"{",closing:"}",add:function(B,z){var y,A;if(B&&!this.contains(B)){if(typeof z=="number"){for(y=0;y<this.evaluators.length;y++){A=this.evaluators[y];if(A.priority<=z){this.evaluators.splice(y,0,{f:B,priority:z})}}}else{this.evaluators.push({f:B,priority:0})}}},remove:function(z){var y=this.indexOf(z);if(y!=-1){this.evaluators.splice(y,1)}},contains:function(y){return this.indexOf(y)!=-1},indexOf:function(z){var y;for(y=0;y<this.evaluators.length;y++){if(this.evaluators[y].f===z){return y}}return -1},clear:function(){this.evaluators=[]},resolve:function(J,E){if(!J){return null}var K,B,A,L,F,D,y,C,H,I,G,z;if(typeof E=="object"){K=J.split(this.opening);B=K[0];for(F=1;F<K.length;F++){y=K[F-1];C=K[F];if(y.charAt(y.length-1)=="\\"){B+=this.opening+C;continue}H=C.indexOf(this.closing);if(H==-1){n.error("ERROR: Missing closing tag in expression: '"+C+"'")}I=a.trim(C.substring(0,H));for(D=0;D<this.evaluators.length;D++){G=this.evaluators[D].f;L=G(I,E);if(L){break}}z=C.substring(H+1);B+=L+z}B=B.replace("\\"+this.opening,this.opening);B=B.replace("\\"+this.closing,this.closing);A=B}else{A=J}return A}};var m={apply:function(D,C,B){var F=B.resolver||new h(),A,E,y,z;if(!D||!C){return}for(i=0;i<C.length;i++){A=C[i];E=D;if(A.target){E=B.selector(A.target,D)}if(E){y=A.name||B.defaultPropName;z=A.value;if(typeof A.value=="string"){z=F.resolve(A.value,t.props)}E[y]=z}}},resolve:function(y,z){var A=z.resolver||new h(),B;for(B in y){y[B]=new h().resolve(y[B],t.props)}}};var u={apply:function(A,C,z){var y,B;for(y=0;y<C.length;y++){B=C[y];A[B.name]=B.value}}};var l=function(y,z,A){this.id=y.id;this.context=y;this.request=z;this.session=A};var p=function(y,z,A){this.id=y.id;this.context=y;this.request=z;this.session=A;this._callers=[]};p.prototype={addCaller:function(y){if(!this.existsCaller(y)){this._callers.push(y)}},removeCaller:function(z){var y=this._callers.indexOf(z);if(y!=-1){this._callers.splice(y,1)}},existsCaller:function(A){var z=false,y;for(y=0;y<this._callers;y++){if(this._callers[y]==A){z=true;break}}return z},getCallers:function(){return this._callers}};var o={createPage:function(y,z,B){var A=new l(y,z,B),C=this._buildStateManager(y,B);A.master=this._buildMaster(y,z,B,C);C.master=A.master;return A},createBlock:function(y,z,A){var C=new p(y,z,A),B=this._buildStateManager(y,A);C.master=this._buildMaster(y,z,A,B);B.master=C.master;return C},_buildMaster:function(z,C,D,E){var y,B,A=a.trim(z.type).toLowerCase();if(A!=""){y=D.viewMasters[A]}else{y=D.defaultViewMasterClass}if(y){if(typeof y=="function"){B=new y(z,C,D,E)}else{n.error("The type '"+A+"' in "+z.id+" cannot create a new page")}}else{n.error("The type '"+A+"' cannot be resolved in page: "+z.id)}return B},_buildStateManager:function(A,B){var y,C,z=a.trim(A.manager).toLowerCase();if(z!=""){y=B.stateManagers[z]}else{y=B.defaultStateManagerClass}if(y){if(typeof y=="function"){C=new y(null,B)}else{n.error("The manager '"+z+"' in "+A.id+" cannot create a valid state manager")}}else{n.error("The manager '"+z+"' cannot be resolved in: "+A.id)}return C}};var x={init:function(){var C=this.AbstractMaster=function(F,G,H,I){var E;this.context=F;this.request=G;this.session=H;this.stateManager=I;this.isCleared=false;if(this.context.mediator){E=a.find(this.context.mediator);if(typeof E=="function"){this.fMediator=E}}};C.prototype={display:function(){var E;n.info("Displaying "+this.context.id+" with target "+this.context.target);this.onDisplay(this);E=a.trim(this.context.container);if(E!=""){this.container=this.session.selector(this.context.container,this.session.root);if(this.container==null){n.error("Invalid container for page "+this.context.id+": "+this.context.container)}}},destroy:function(){n.info("Destroying "+this.context.id);if(this.mediator&&typeof this.mediator.destroy=="function"){this.mediator.destroy()}if(this.stateManager){this.stateManager.destroy()}},clear:function(){n.info("Clearing "+this.context.id);this.onClear(this);if(this.stateManager){this.stateManager.setState(w.STATE_OUT)}},init:function(){n.debug("Initializing "+this.context.id);if(this.target){m.apply(this.target,this.context.propContexts,this.session);a.merge(this.target,this.request.params);this.onCreate(this);if(this.stateManager){this.stateManager.target=this.target;e.observe(this.stateManager,"onStateChange",this.onStateChange,this);this.stateManager.setState(w.STATE_IN)}}if(this.fMediator){this.mediator=new this.fMediator(this.target);m.apply(this.mediator,this.context.propContexts,this.session);a.merge(this.mediator,this.request.params);if(typeof this.mediator.init=="function"){this.mediator.init()}}this.onInit(this)},onStateChange:function(F,E){if(E==w.STATE_IN){this.onIn(this)}else{if(E==w.STATE_ON){this.onOn(this)}else{if(E==w.STATE_OUT){this.onOut(this)}else{if(E==w.STATE_OFF){this.onOff(this);this.destroy()}}}}},onDisplay:function(E){},onClear:function(E){},onCreate:function(E){},onInit:function(E){},onIn:function(E){},onOn:function(E){},onOut:function(E){},onOff:function(E){}};var B=this.DomMaster=this.createViewMaster({display:function(){n.debug("DomMaster display: "+this.context.id);this.target=this.session.selector(this.context.target);if(this.target==null){n.error("Invalid target for page "+this.context.id+": "+this.context.target);return}if(this.cloneDom){this.target=this.target.cloneNode(true);this.container.appendChild(this.target)}this.originalDisplay=this._getStyle(this.target,"display");this.originalVisibility=this._getStyle(this.target,"visibility");if(this.originalDisplay=="none"){this.target.style.display="inherit"}if(this.originalVisibility=="hidden"){this.target.style.visibility="visible"}this.init()},destroy:function(){n.debug("DomMaster destroy: "+this.context.id);this.target.style.display=this.originalDisplay;this.target.style.visibility=this.originalVisibility;if(this.cloneDom){this.container.removeChild(this.target)}},_getStyle:function(H,F){var G,E;if(H.currentStyle){G=H.currentStyle[F]}else{if(j.getComputedStyle){E=j.getComputedStyle(H,null);if(E){G=E.getPropertyValue(F)}}}return G}},C);var D=this.DomCloneMaster=this.createViewMaster({cloneDom:true},B);var A=this.LoaderMaster=this.createViewMaster({display:function(){n.debug("LoaderMaster display");this.loader=new g();this.loader.load(this.context.target,this.onLoaded,this)},destroy:function(){n.debug("LoaderMaster destroy");this.container.innerHTML=""},onLoaded:function(E){n.debug("LoaderMaster received content");this.target=E.responseText;this.container.innerHTML=this.target;this.init()}},C);var z=this.BuilderMaster=this.createViewMaster({display:function(){n.debug("BuilderMaster display");this.fConstructor=a.find(this.context.target);if(typeof this.fConstructor!="function"){n.error("Invalid target for page "+this.context.id+": "+this.context.target);return}this.builder=new this.fConstructor();this.target=this.builder.build();this.container.appendChild(this.target);this.init();if(typeof this.builder.init=="function"){this.builder.init()}},destroy:function(){n.debug("BuilderMaster destroy");if(typeof this.builder.destroy=="function"){this.builder.destroy()}if(this.target){this.container.removeChild(this.target)}},init:function(){m.apply(this.builder,this.context.propContexts,this.session);a.merge(this.builder,this.request.params)}},C);var y=this.VoidMaster=this.createViewMaster({display:function(){this.init()},clear:function(){this.destroy()}},C)},createViewMaster:function(y,z){var B,A;y=y||{};z=z||this.AbstractMaster;B=function(){z.apply(this,arguments)};B.prototype=new z(arguments);for(A in y){if(y.hasOwnProperty(A)){if(typeof y[A]=="function"&&typeof B.prototype[A]=="function"){e.observe(B.prototype,A,y[A],B)}else{B.prototype[A]=y[A]}}}return B}};var w={STATE_IN:"IN",STATE_ON:"ON",STATE_OUT:"OUT",STATE_OFF:"OFF",init:function(){var y=this.BaseIo3Manager=function(A,z){this.target=A;this.session=z;this._state=null};y.prototype={destroy:function(){},getState:function(){return this._state},setState:function(z){z=z.toUpperCase();if(z!=w.STATE_IN&&z!=w.STATE_ON&&z!=w.STATE_OUT&&z!=w.STATE_OFF){n.warn("Unknown state, returning without changing state for target "+this.target);return}if(z!=this._state){this._state=z;this._changeState()}},doIn:function(){this.setState(w.STATE_ON)},doOn:function(){},doOut:function(){this.setState(w.STATE_OFF)},doOff:function(){},_changeState:function(){this.onStateChange(this.target,this._state);if(this._state==w.STATE_IN){this.doIn()}else{if(this._state==w.STATE_ON){this.doOn()}else{if(this._state==w.STATE_OUT){if(this.target!=null){this.doOut()}else{n.info("target is null when trying to set state to OUT, setting state to OFF instead of calling doOut to avoid errors.");this._state=w.STATE_OFF}}else{if(this._state==w.STATE_OFF){this.doOff()}}}}},onStateChange:function(A,z){}}},createStateManager:function(){var B,A=typeof arguments[0]=="object",y=A?arguments[0]:{},z=A?arguments[1]:arguments[2];z=z||this.BaseIo3Manager;if(!A){if((typeof arguments[0]=="function")&&(typeof arguments[1]=="function")){y.doIn=arguments[0];y.doOut=arguments[1]}else{n.warn("Malformed call to createStateManager - either createStateManager(conf, [parent]) or createStateManager(doIn, doOut, [parent]) are allowed.")}}B=function(){z.apply(this,arguments)};B.prototype=new z();a.merge(B.prototype,y);return B}};var q=function(y,z,A){this.id=y.id;this.context=y;this.request=z;this.session=A};var d={createCommand:function(y,z,A){var B=new q(y,z,A);B.master=this._buildMaster(y,z,A);return B},_buildMaster:function(z,C,D){var y,B,A=a.trim(z.type).toLowerCase();if(A!=""){y=D.commandMasters["_"+A]}else{y=D.defaultCommandMasterClass}if(y){if(typeof y=="function"){B=new y(z,C,D)}else{n.error("The type "+A+" in "+z.id+" cannot create a new command")}}else{n.error("The type "+A+" cannot be resolved in command: "+z.id)}return B}};var s={init:function(){var z=this.AbstractMaster=function(A,B,C){this.context=A;this.request=B;this.session=C;this.isExecuted=false};z.prototype={execute:function(){n.debug("Initializing "+this.context.id)}};var y=this.FunctionMaster=this.createCommandMaster(function(){var C=a.find(this.context.target),A=[],B=a.mix(this.context.props,this.request.params);m.resolve(B,this.session);if(B._args&&B._args.length){A=B._args.slice(0)}if(!a.isEmpty(B)){A.push(B)}if(typeof C=="function"){C.apply(null,A)}else{n.warn("There is no function to execute for command '"+this.context.id+"' and target '"+this.context.target+"'.")}this.isExecuted=true},z)},createCommandMaster:function(A,B){var z,C=typeof A=="object",y=C?A:{};B=B||this.AbstractMaster;if(!C){if(typeof arguments[0]=="function"){y.execute=A}else{n.warn("Malformed call to createCommandMaster - either createCommandMaster(conf, [parent]) or createCommandMaster(fExecute, [parent]) are allowed.")}}z=function(){B.apply(this,arguments)};z.prototype=new B();a.merge(z.prototype,y);return z}};var c={parse:function(z,A){var y={};y.propContexts=this._parsePropContexts(z.getElementsByTagName("zumo")[0],A);y.props=this._getPropsFromPropContexts(y.propContexts);y.includes=this._parseIncludes(z,A);y.views=this._parseViews(z,A);y.commands=this._parseCommands(z,A);return y},_parseIncludes:function(y,E){var B=y.getElementsByTagName("include"),C,A=[],D,z;for(z=0;z<B.length;z++){C=B[z];D=C.attributes.getNamedItem("target").nodeValue;if(!a.isEmpty(D)){A.push(D)}}return A},_parseViews:function(C,E){var A=C.getElementsByTagName("views"),H={pages:[],blocks:[]},F,G,z,D,B,y;if(A.length>1){n.warn("There can only be zero or one views nodes on the XML configuration, there were "+A.length+" views nodes found");return null}else{if(A.length==0){n.info("No views to parse");return null}}F="page";G=A[0].getElementsByTagName(F);for(y=0;y<G.length;y++){D=this._parsePageBlock(G[y],E);if(D){D.node=F;this._mergeAttributes(D,G[y],["parent"]);D.parentId=D.parent;D.parent=null;D.children=[];H.pages.push(D)}}F="block";z=A[0].getElementsByTagName(F);for(y=0;y<z.length;y++){B=this._parsePageBlock(z[y],E);if(B){B.node=F;H.blocks.push(B)}}return H},_parsePageBlock:function(y,A){var z={},C,B;this._mergeAttributes(z,y,["id","type","mediator","target","container","manager","title"]);C=y.attributes.getNamedItem("depends");if(C){B=C.nodeValue.replace(/\s/g,"").split(",");if(!(B.length==1&&B[0]=="")){z.depends=B}}z.propContexts=this._parsePropContexts(y,A);z.props=this._getPropsFromPropContexts(z.propContexts);z.handlers=this._parseHandlers(y,A);return z},_parseCommands:function(z,E){var C=z.getElementsByTagName("commands"),y=[],D,B,A;if(C.length>1){n.warn("There can only be zero or one commands nodes on the XML configuration, there were "+C.length+" commands nodes found")}else{if(C.length==0){n.info("No commands to parse")}else{D=C[0].getElementsByTagName("command");for(A=0;A<D.length;A++){B={};this._mergeAttributes(B,D[A],["id","type","target"]);B.propContexts=this._parsePropContexts(D[A],E);B.props=this._getPropsFromPropContexts(B.propContexts);B.handlers=this._parseHandlers(D[A],E);y.push(B)}}}return y},_parsePropContexts:function(y,D){var A=a.getChildren(y,"prop"),C=[],B,z;for(z=0;z<A.length;z++){B=this._parsePropContext(A[z],D);if(B){C.push(B)}}return C},_parsePropContext:function(y,A){var z={};this._mergeAttributes(z,y,["name","target"]);z.value=this._parsePropValue(y,A);return z},_parsePropValue:function(E,G){var y={},B,C,z,F,D,A;this._mergeAttributes(y,E,["name","value"]);B=a.getChildren(E).length>0;C=a.getChildren(E,"item");z=a.getChildren(E,"prop");if(B){if(y.value){n.warn("Both value attribute and children nodes found on prop: '"+y.name+"'. Only value attribute will be used.")}else{if(z.length>0){if(C.length>0){n.warn("Both prop and item nodes found on prop: '"+y.name+"'. Only prop nodes will be used.")}y.value={};for(A=0;A<z.length;A++){F=z[A];D=F.attributes.getNamedItem("name").nodeValue;y.value[D]=this._parsePropValue(F)}}else{if(C.length>0){y.value=[];for(A=0;A<C.length;A++){y.value.push(this._parsePropValue(C[A]))}}}}}else{if(y.value){if(E.firstChild&&a.trim(E.firstChild.nodeValue)!=""){n.warn("Both value attribute and text content found on prop: '"+y.name+"'. Only value attribute will be used.")}}else{y.value=E.firstChild.nodeValue}}return y.value},_getPropsFromPropContexts:function(A){var z={},y;for(y=0;y<A.length;y++){z[A[y].name]=A[y].value}return z},_mergeAttributes:function(D,A,C){var z,y,B;for(z=0;z<C.length;z++){y=C[z];if(y&&a.trim(y)!=""){B=A.attributes.getNamedItem(y);if(B){D[y]=B.nodeValue}}}},_parseHandlers:function(A,D){var y=A.getElementsByTagName("handler"),z=[],C,B;for(B=0;B<y.length;B++){C=this._parseHandler(y[B],D);if(C){z.push(C)}}return z},_parseHandler:function(y,A){var z={};n.debug(y);this._mergeAttributes(z,y,["type","target","priority","class","at","action","priority"]);z.params=this._parseParams(y,A);return z},_parseParams:function(z,C){var B=z.getElementsByTagName("param"),D=[],y,A;for(A=0;A<B.length;A++){y=this._parseParam(B[A],C);if(y){D.push(y)}}return D},_parseParam:function(z,A){var y={};this._mergeAttributes(y,z,["name","value"]);n.debug(z);if(!y.value){y.value=z.firstChild.nodeValue}return y}};var f=function(y){this.app=y;this._activeHandlers=[];this._bindings=[];this.updateBindings=false;this.hasRegistered=false};f.prototype={registerHandlers:function(){var D=this.app.getPageContexts(),C=this.app.getBlockContexts(),E=this.app.getCommandContexts(),z,y,B,A;if(this.hasRegistered){this.unregisterHandlers()}for(A=0;A<D.length;A++){z=D[A];this._registerHandlersFromContext(z,"page")}for(A=0;A<C.length;A++){y=C[A];this._registerHandlersFromContext(y,"block")}for(A=0;A<E.length;A++){B=E[A];this._registerHandlersFromContext(B,"command")}this.hasRegistered=true;this.updateBindings=this._updateBindings();n.debug("Will update bindings? "+this.updateBindings);if(this.updateBindings){e.observe(this.app,"onPageInit",this.onViewInit,this);e.observe(this.app,"onBlockInit",this.onViewInit,this)}},unregisterHandlers:function(){var y;while(this._activeHandlers.length>0){y=this._activeHandlers.pop();this._removePageBlockHandlerAction(y)}e.ignore(this.app,"onPageInit",this.onViewInit);e.ignore(this.app,"onBlockInit",this.onViewInit)},_registerHandlersFromContext:function(A,y){var B,z;for(z=0;z<A.handlers.length;z++){B={handlerContext:A.handlers[z],context:A,contextType:y,f:this._createHandlerAction(A.handlers[z],A,y)};this._activeHandlers.push(B)}},_createHandlerAction:function(A,z,y){if(y=="page"){return this._createPageHandlerAction(A,z)}else{if(y=="block"){return this._createBlockHandlerAction(A,z)}else{if(y=="command"){return this._createCommandHandlerAction(A,z)}else{n.warn("Could not create handler action - the context type is neither a page or a block");return null}}}},_createPageHandlerAction:function(z,y){var C=this.app,B,A=function(){var E=arguments[1],D=C.getCurrentPage(),F;if(!z.at||z.at==""||z.at==D.id){if(D&&y.id==D.id){n.debug("Handler "+z.type+"trigger when already at "+D.id);u.apply(D.master.target,z.params,this.session)}else{F=a.delegate(C.go,C,y.id,E);setTimeout(F,10)}}};if(z.action=="go"||z.action=="go"||z.action=="call"||z.action==""||z.action==null){B=A}else{n.warn("Could not resolve handler action: "+z.action)}this._registerBinding(z.type,B,z.target);return B},_createBlockHandlerAction:function(A,y){var D=this.app,C,z=function(){var F=arguments[1],E;if(!A.at||A.at==""||A.at==D.getCurrentPage().id){E=D.getDisplayedBlock(y.id);if(E){u.apply(E.master.target,A.params,this.session)}else{D.displayBlock(y.id,F)}}},B=function(){if(!A.at||A.at==""||A.at==D.getCurrentPage().id){D.clearBlock(y.id)}};if(A.action=="clear"||A.action=="clearBlock"){C=B}else{if(A.action=="displayBlock"||A.action=="display"||A.action=="call"||A.action==""||A.action==null){C=z}else{n.warn("Could not resolve handler action: "+A.action)}}this._registerBinding(A.type,C,A.target);return C},_createCommandHandlerAction:function(y,z){var C=this.app,A,B=function(){var D=C.getCurrentPage(),E;if(!y.at||y.at==""||y.at==D.id){E=arguments[1];C.execute(z.id,E)}};if(y.action=="execute"||y.action==""||y.action==null){A=B}else{n.warn("Could not resolve handler action: "+y.action)}this._registerBinding(y.type,A,y.target);return A},_removePageBlockHandlerAction:function(y){if(y.contextType=="page"){this._removePageHandlerAction(y)}else{if(y.contextType=="block"){this._removeBlockHandlerAction(y)}else{n.warn("Could not remove handler action - the context type is neither a page or a block")}}},_removePageHandlerAction:function(y){},_removeBlockHandlerAction:function(y){},_registerBinding:function(z,y,A){this._bindings.push({type:z,f:y,target:A})},_bindHandler:function(z,y,A){n.info("There is no handler binder implemented");return true},_unbindHandler:function(z,y,A){n.info("There is no handler unbinder implemented");return true},_updateBindings:function(A){var B,z,y=false;for(z=0;z<this._bindings.length;z++){B=this._bindings[z];if(!A||B.target){this._unbindHandler(B.type,B.f,B.target);if(!this._bindHandler(B.type,B.f,B.target)){y=true}}}return y},onViewInit:function(){this._updateBindings(true)}};var t={Utils:a,ExpressionResolver:h,Loader:g,ViewMasters:x,StateManagers:w,_VIEW_MASTERS:{dom:"DomMaster",domclone:"DomCloneMaster",loader:"LoaderMaster",builder:"BuilderMaster",_void:"VoidMaster"},_DEFAULT_VIEW_TYPE:"dom",_STATE_MANAGERS:{base:"BaseIo3Manager"},_DEFAULT_STATE_MANAGER:"base",_COMMAND_MASTERS:{_function:"FunctionMaster"},_DEFAULT_COMMAND_TYPE:"_function",_DEFAULT_PROP_NAME:"innerHTML",_PARAM_NAME_CALLER:"_caller",log:n,root:null,props:null,session:{viewMasters:{},defaultViewMasterClass:null,stateManagers:{},defaultStateManagerClass:null,commandMasters:{},defaultCommandMasterClass:null,selector:r.select,confParsers:[]},_conf:null,_confTargets:[],_params:null,_currentPage:null,_displayedPage:null,_displayedBlocks:[],_handlerManager:null,startup:function(){this["goto"]=this.go;this._VIEW_MASTERS["void"]=this._VIEW_MASTERS._void;n.prefix=v?v.toUpperCase()+" - ":"";this._initViewMasters();this._initStateManagers();this._initCommandMasters()},init:function(){var y,z,A;if(typeof arguments[0]=="string"){z=arguments[0];A=arguments[1]}else{if(arguments.length>1){y=arguments[0];z=arguments[1];A=arguments[2]}}y=y||document;z=z||y;this._params=A||{};this.root=y;n.info("Initializing Zumo object with root "+y);this._displayedBlocks=[];this.session.id=this._params.id||this._createSessionId();this.session.root=y;this.session.defaultPropName=this._DEFAULT_PROP_NAME;this.session.confParsers.push(this._parseConf);this._handlerManager=new f(this);this._initConf(z);n.info("New Zumo session created with id: "+this.session.id)},destroy:function(){n.debug("Destroying Zumo object");this.session={};this.root=this._conf=this._params=this._currentPage=this._displayedPage=null},isInit:function(){return this.root!=null&&this._conf!=null},go:function(C,B){var y,z,A;n.info("Going to page "+C);if(!this.isInit()){n.warn("Cannot go "+C+" - Zumo is not yet initalized");return}B=B||{};if(this._currentPage!=null){n.debug("currentPage id = "+this._currentPage.id);if(C==this._currentPage.context.id){n.info("No page to go - we are already in "+C);return}}else{n.debug("currentPage is null")}y=this.getPageContext(C);if(!y||typeof y!=="object"){n.error("No page context found with id: "+C);return}z={id:C,params:B,referrer:this._currentPage};A=o.createPage(y,z,this.session);this.onPageRequest(y,z);if(A.master==null){return}e.observe(A.master,"onDisplay",this.onPageDisplay,this);e.observe(A.master,"onClear",this.onPageClear,this);e.observe(A.master,"onCreate",this.onPageCreate,this);e.observe(A.master,"onInit",this.onPageInit,this);e.observe(A.master,"onIn",this.onPageIn,this);e.observe(A.master,"onOn",this.onPageOn,this);e.observe(A.master,"onOut",this.onPageOut,this);e.observe(A.master,"onOff",this.onPageOff,this);if(this._currentPage!=null){this._currentPage.master.clear()}this._currentPage=A;A.master.display();this._displayedPage=A;this._displayDepends(A)},getPageContext:function(B){var y,z,A;if(!this.isInit()){n.warn("Cannot get page context ("+B+")- Zumo is not yet initalized");return null}if(this._conf.views==null){n.info("Cannot get page context since there are no views configured");return null}for(z=0;z<this._conf.views.pages.length;z++){A=this._conf.views.pages[z];if(A.id==B){y=A;break}}return y},getPageContexts:function(){return this._conf.views.pages},getPageContextsAt:function(B){var y=[],A,z;for(A=0;A<this._conf.views.pages.length;A++){z=this._conf.views.pages[A];if(z.level==B){y.push(z)}}return y},getDisplayedPage:function(){return this._displayedPage},getCurrentPage:function(){return this._currentPage},getPageLevel:function(A){var z=0,y=this.getPageContext(A);if(y.parentId!=null){z=this.getPageLevel(y.parentId)+1}return z},displayBlock:function(C,B){var A,z,y;n.info("Displaying block "+C);if(!this.isInit()){n.warn("Cannot display "+C+" - Zumo is not yet initalized");return}B=B||{};A=this.getDisplayedBlock(C);if(A){if(B[this._PARAM_NAME_CALLER]){A.addCaller(B[this._PARAM_NAME_CALLER])}else{A.addCaller(A.id)}n.info("No block to display - the block is already displayed: "+C)}else{y=this.getBlockContext(C);if(!y||typeof y!=="object"){n.error("No block context found with id: "+C);return}z={id:C,params:B};A=o.createBlock(y,z,this.session);this.onBlockRequest(y,z);if(A.master==null){return}e.observe(A.master,"onDisplay",this.onBlockDisplay,this);e.observe(A.master,"onClear",this.onBlockClear,this);e.observe(A.master,"onCreate",this.onBlockCreate,this);e.observe(A.master,"onInit",this.onBlockInit,this);e.observe(A.master,"onIn",this.onBlockIn,this);e.observe(A.master,"onOn",this.onBlockOn,this);e.observe(A.master,"onOut",this.onBlockOut,this);e.observe(A.master,"onOff",this.onBlockOff,this);if(B[this._PARAM_NAME_CALLER]){A.request.caller=B[this._PARAM_NAME_CALLER]}else{A.request.caller=A.id}A.addCaller(A.request.caller);A.master.display();this._addDisplayedBlock(A);this._displayDepends(A)}},clearBlock:function(z){n.info("Clearing block "+z);var y=this.getDisplayedBlock(z);if(!y){n.info("There is no block to clear with id "+z);return}if(y.master.isCleared){n.info("The block is already being cleared: "+z);return}y.master.clear();this._removeDisplayedBlock(z);this._clearDepends(y)},getBlockContext:function(B){var y,A,z;if(!this.isInit()){n.warn("Cannot get block context ("+B+")- Zumo is not yet initalized");return null}if(this._conf.views==null){n.info("Cannot get block context since there are no views configured");return null}for(A=0;A<this._conf.views.blocks.length;A++){z=this._conf.views.blocks[A];if(z.id==B){y=z;break}}return y},getBlockContexts:function(){return this._conf.views.blocks},getDisplayedBlock:function(A){var z,y;for(y=0;y<this._displayedBlocks.length;y++){if(this._displayedBlocks[y].id==A){z=this._displayedBlocks[y];break}}return z},getDisplayedBlocks:function(y){return this._displayedBlocks},registerViewMaster:function(y,z){if(a.trim(y)==""){n.warn("Cannot register a view master with an empty name");return}y=y.toLowerCase();if(typeof z!="function"){n.warn("Cannot register view master with name "+y+" - master is not a function");return}if(this.session.viewMasters[y]==null){this.session.viewMasters[y]=z}else{n.warn("Cannot register view master with name "+y+" - there is already registered a master with that name")}},unregisterViewMaster:function(y){this.session.viewMasters[y]=null},createViewMaster:function(){var y=arguments[0],z=x.createViewMaster.apply(x,[].slice.call(arguments,1));this.registerViewMaster(y,z);return z},registerStateManager:function(y,z){if(a.trim(y)==""){n.warn("Cannot register a state manager with an empty name");return}y=y.toLowerCase();if(typeof z!="function"){n.warn("Cannot register state manager with name "+y+" - manager is not a function");return}if(this.session.stateManagers[y]==null){this.session.stateManagers[y]=z}else{n.warn("Cannot register state manager with name "+y+" - there is already registered a manager with that name")}},unregisterStateManager:function(y){this.session.stateManagers[y.toLowerCase()]=null},createStateManager:function(){var y=arguments[0],z=w.createStateManager.apply(w,[].slice.call(arguments,1));this.registerStateManager(y,z);return z},execute:function(C,B){var y,z,A;n.info("Executing command "+C);if(!this.isInit()){n.warn("Cannot execute "+C+" - Zumo is not yet initalized");return}B=B||{};y=this.getCommandContext(C);if(!y||typeof y!=="object"){n.error("No command context found with id: "+C);return}z={id:C,params:B};A=d.createCommand(y,z,this.session);A.master.execute(z)},getCommandContexts:function(){return this._conf.commands},getCommandContext:function(B){var z,y,A;if(!this.isInit()){n.warn("Cannot get command context ("+B+")- Zumo is not yet initalized");return null}if(this._conf.commands==null||this._conf.commands.length==0){n.info("Cannot get block context since there are no commands configured");return null}for(y=0;y<this._conf.commands.length;y++){A=this._conf.commands[y];if(A.id==B){z=A;break}}return z},registerCommandMaster:function(y,z){if(a.trim(y)==""){n.warn("Cannot register a command master with an empty name");return}y=y.toLowerCase();if(typeof z!="function"){n.warn("Cannot register command master with name "+y+" - command is not a function");return}if(this.session.commandMasters[y]==null){this.session.commandMasters[y]=z}else{n.warn("Cannot register command master with name "+y+" - there is already registered a master with that name")}},unregisterCommandMaster:function(y){this.session.commandMasters[y]=null},createCommandMaster:function(){var y=arguments[0],z=s.createCommandMaster.apply(s,[].slice.call(arguments,1));this.registerCommandMaster(y,z);return z},observe:function(A,z,y){e.observe(this,A,z,y)},ignore:function(z,y){e.ignore(this,z,y)},_initConf:function(y){var z;if(typeof y=="string"){n.info("Initializing with remote configuration: "+y);if(this._confTargets.length==0){this._confTargets.push({target:y,isParsed:false})}z=new g();z.load(y,this._onConfLoaded,this,[y])}else{this._processConf(y)}},_initViewMasters:function(){var z,y;x.init();for(z in this._VIEW_MASTERS){y=this._VIEW_MASTERS[z];this.registerViewMaster(z,x[y])}this.session.defaultViewMasterClass=this.session.viewMasters[this._DEFAULT_VIEW_TYPE]},_initStateManagers:function(){var z,y;w.init();for(z in this._STATE_MANAGERS){y=this._STATE_MANAGERS[z];this.registerStateManager(z,w[y])}this.session.defaultStateManagerClass=this.session.stateManagers[this._DEFAULT_STATE_MANAGER]},_initCommandMasters:function(){var z,y;s.init();for(z in this._COMMAND_MASTERS){y=this._COMMAND_MASTERS[z];this.registerCommandMaster(z,s[y])}this.session.defaultCommandMasterClass=this.session.commandMasters[this._DEFAULT_COMMAND_TYPE]},_createSessionId:function(){if(j._nZumo==null){j._nZumo=0}j._nZumo++;return v+j._nZumo},_addDisplayedBlock:function(y){if(!this.getDisplayedBlock(y.id)){this._displayedBlocks.push(y)}},_removeDisplayedBlock:function(z){var y;for(y=0;y<this._displayedBlocks.length;y++){if(this._displayedBlocks[y].id==z){break}}this._displayedBlocks.splice(y,1)},_displayDepends:function(B){var y,C,z,A;n.debug("Displaying depends for "+B.id);if(!B){return}y=this._getFlattenedDepends(B);for(A=0;A<y.length;A++){C={};C[this._PARAM_NAME_CALLER]=B.id;this.displayBlock(y[A],C)}if(B.context.node=="page"){z=B.request.referrer;if(z!=null){this._clearDepends(z)}}},_clearDepends:function(A){var y,z,B;n.debug("Clearing depends for "+A.id);if(!A){return}y=this._getFlattenedDepends(A);for(z=0;z<y.length;z++){B=this.getDisplayedBlock(y[z]);if(!B){continue}B.removeCaller(A.id);if(B.getCallers().length==0){this.clearBlock(B.id)}}},_getFlattenedDepends:function(D,B){var z=B||[],C=D.depends,A,E,y;if(!C&&D.context){C=D.context.depends}if(!C){return[]}if(!Array.indexOf){Array.prototype.indexOf=function(G){for(var F=0;F<this.length;F++){if(this[F]==G){return F}}return -1}}for(A=0;A<C.length;A++){E=C[A];if(z.indexOf(E)!=-1){continue}z.push(E);y=this.getBlockContext(E);this._getFlattenedDepends(y,z)}return z},_processConf:function(A){var y,B,z;for(y=0;y<this.session.confParsers.length;y++){B=this.session.confParsers[y];if((typeof B=="function")&&(z=B(A))){break}}if(z.includes&&z.includes.length>0){for(y=0;y<z.includes.length;y++){this._addConfTarget(z.includes[y])}}if(this._conf){a.mergeDeep(this._conf,z)}else{this._conf=z}this.props=this._conf.props;if(this._getPendingConfTargets().length==0){this._processParenting();this._handlerManager.registerHandlers();this.onConfLoaded()}},_addConfTarget:function(A){var y,z;for(y=0;y<this._confTargets.length;y++){if(A==this._confTargets[y].target){n.warn("Duplicated conf target '"+A+"', ignoring...");z=true;break}}if(!z){this._confTargets.push({target:A,isParsed:false});this._initConf(A)}},_markConfTarget:function(z){var y;for(y=0;y<this._confTargets.length;y++){if(z==this._confTargets[y].target){this._confTargets[y].isParsed=true;break}}},_getPendingConfTargets:function(){var y,z=[];for(y=0;y<this._confTargets.length;y++){if(!this._confTargets[y].isParsed){z.push(this._confTargets[y].target)}}return z},_processParenting:function(){var y=this.getPageContexts(),A,z,B;for(A=0;A<y.length;A++){z=y[A];if(z.parentId){B=this.getPageContext(z.parentId);if(!B){n.warn("Parent node '"+z.parentId+"' cannot be found for '"+z.id+"'");continue}if(!z.parent){z.parent=B;B.children.push(z);z.level=this.getPageLevel(z.id)}}}},_parseConf:function(y){return c.parse(y,this.session)},onConfLoaded:function(){},onPageRequest:function(y,z){},onPageDisplay:function(y){},onPageClear:function(y){},onPageCreate:function(y){},onPageInit:function(y){},onPageIn:function(y){},onPageOn:function(y){},onPageOut:function(y){},onPageOff:function(y){},onBlockRequest:function(y,z){},onBlockDisplay:function(y){},onBlockClear:function(y){},onBlockCreate:function(y){},onBlockInit:function(y){},onBlockIn:function(y){},onBlockOn:function(y){},onBlockOut:function(y){},onBlockOff:function(y){},_onConfLoaded:function(y,z){n.info("Conf was loaded, target = "+z);this._markConfTarget(z);this._processConf(y.responseXML)}};var k={addHandlerBinder:function(z,A,y){f.prototype._bindHandler=z;f.prototype._unbindHandler=A},setSelector:function(y){if(y&&typeof y=="function"){t.session.selector=y}else{n.warn("Could not create a selector function from "+y)}},addConfParser:function(y){t.session.confParsers.unshift(y)}};t.startup();j.Zumo=t;j.ZumoExt=k;j.ZumoAgent=e})(this);(function(f){if(!Zumo||!ZumoExt){return}var c=function(j){var h=$("*[id]",j.target),k="z-";h.each(function(){var n=$(this),l=n.attr("id"),m=l.indexOf(k);if(m==0){n.attr("id",l.substr(k.length))}})};Zumo.observe("onPageCreate",c);Zumo.observe("onBlockCreate",c);var e=function(k,j,l){l=l||$("body");var h=$(l);if(h.length>0){$(l).on(k,j);return true}else{return false}};var d=function(k,j,l){l=l||f;var h=$(l);if(h.length>0){h.off(k,j);return true}else{return false}};ZumoExt.addHandlerBinder(e,d,true);var b=function(h,j){return $(h,j)[0]};ZumoExt.setSelector(b);var a=function(h,j,k,l){Zumo.ViewMasters.AbstractMaster.call(this,h,j,k,l)};a.prototype={display:function(){Zumo.ViewMasters.AbstractMaster.prototype.display.apply(this,arguments);var h=this;this.$container=$(this.container);this.$container.load(this.context.target,function(){h.init()})},destroy:function(){Zumo.ViewMasters.AbstractMaster.prototype.destroy.apply(this,arguments);this.$container.clear()},init:function(){Zumo.ViewMasters.AbstractMaster.prototype.init.apply(this,arguments)},clear:function(){Zumo.ViewMasters.AbstractMaster.prototype.clear.apply(this,arguments)},onStateChange:function(j,h){Zumo.ViewMasters.AbstractMaster.prototype.onStateChange.apply(this,arguments)},onDisplay:function(h){},onClear:function(h){},onInit:function(h){},onIn:function(h){},onOn:function(h){},onOut:function(h){},onOff:function(h){}};Zumo.registerViewMaster("_$loader",a);(function(j){var h=Zumo.createStateManager("$fade",{duration:"slow",doIn:function(){var l=this,k=$(this.target);k.hide();k.fadeIn(this.duration,function(){l.setState(Zumo.StateManagers.STATE_ON)})},doOut:function(){var k=this;$(this.target).fadeOut(this.duration,function(){k.setState(Zumo.StateManagers.STATE_OFF)})}});Zumo.createStateManager("$fadeSlow",{duration:"slow"},h);Zumo.createStateManager("$fadeFast",{duration:"fast"},h)})(f);var g=function(l){var j={},k,h;if(typeof l!="object"||typeof l.getElementsByTagName!="function"||(l.firstChild&&l.firstChild.nodeName=="zumo")){return null}k=function(s,p,r){var n,m,q;for(n=0;n<r.length;n++){m=r[n];q=$(p).attr("data-"+m);if(q){s[m]=q}}};h=function(r){var u=$(r),n={},o,p,t,m,s,v,q;k(n,r,["type","mediator","container","manager","title"]);n.target=r;o=u.attr("data-depends");if(o){n.depends=o.replace(/\s*,\s*|\s+/g,",").split(",")}else{n.depends=[]}n.handlers=[];p=u.attr("data-handlers");if(p){t=p.split(",");for(q=0;q<t.length;q++){v={};m=t[q];s=m.split("@");if(s.length==2){v.at=Zumo.Utils.trim(s[1]);m=s[0]}else{if(s.length>2){}}s=m.split(":");if(s.length==1){v.type=s[0]}else{if(s.length==2){v.target=s[0];v.type=s[1]}else{}}n.handlers.push(v)}}return n};j.views={pages:[],blocks:[]};j.commands=[];$("*[data-page]",l).each(function(){var m=h(this);m.id=$(this).attr("data-page");m.node="page";j.views.pages.push(m)});$("*[data-block]",l).each(function(){var m=h(this);m.id=$(this).attr("data-block");m.node="block";j.views.blocks.push(m)});return j};ZumoExt.addConfParser(g)})(this);